<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>scan_framework.scans.scan &mdash; NIST Scan Framework For ARTIQ 2.0.0 documentation</title><link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  <link rel="stylesheet" href="https://pages.nist.gov/nist-header-footer/css/nist-combined.css">  
  <script src="https://pages.nist.gov/nist-header-footer/js/nist-header-footer.js" type="text/javascript" defer="defer"></script>
  <!--<script type="text/javascript" src="https://pages.nist.gov/leaveNotice/js/jquery.leaveNotice-nist.min.js"></script>-->
  <link rel="stylesheet" type="text/css" href="https://pages.nist.gov/leaveNotice/css/jquery.leaveNotice.css" />  
  <script type="text/javascript">
	  function link_is_external(link_element) {
	      return (link_element.host !== window.location.host);
	  }
	  (function ($) {
	      $.fn.leaveNotice = function (opt) {
	          var defaults = {
	              siteName: "NIST",
	              exitMessage:
	                  "<h2><strong>Thank you for visiting {SITENAME}.</strong></h2><p>We hope your visit was informative.</p><p>We have provided this link to a non-NIST site because it has information that may be of interest to our users. NIST does not necessarily endorse the views expressed or the facts presented on this site. Further, NIST does not endorse any commercial products that may be advertised or available on this site.</p>",
	              preLinkMessage: "<div class='setoff'><p>You will now be directed to:<br/>{URL}</p></div>",
	              linkString: "",
	              newWindow: false,
	              timeOut: 1e4,
	              overlayId: "ln-blackout",
	              messageBoxId: "ln-messageBox",
	              messageHolderId: "ln-messageHolder",
	              linkId: "ln-link",
	              displayUrlLength: 50,
	              overlayAlpha: 0.3,
	          };
	          var options = $.extend(defaults, opt);
	          return this.each(function () {
				  if(link_is_external(this)) {
		              el = $(this);
					  $(this).unbind();
		              var url = el.attr("href");
		              var ulen = options.displayUrlLength;
		              if (url.length >= ulen) {
		                  var suffix = "...";
		              } else {
		                  var suffix = "";
		              }
		              var shortUrl = url.substr(0, ulen) + suffix;
		              var title = el.attr("title");
		              if (title === undefined || title == "") {
		                  var linkText = shortUrl;
		              } else {
		                  var linkText = title;
		              }
		              options.timeOut = options.newWindow ? 0 : options.timeOut;
		              el.click(function (event) {
						  event.preventDefault();
		                  $("body").append('<div id="' + options.overlayId + '"></div>');
		                  $("body").append('<div id="' + options.messageHolderId + '"><div id="' + options.messageBoxId + '"></div></div>');
		                  if (options.overlayAlpha !== false) {
		                      $("#" + options.overlayId).css("opacity", options.overlayAlpha);
		                  }
		                  preFilteredContent = options.exitMessage + options.preLinkMessage;
		                  msgContent = preFilteredContent.replace(/\{URL\}/g, '<a id="' + options.linkId + '" href="' + url + '" title="' + url + '"' + options.linkString + ">" + linkText + "</a>");
		                  msgContent = msgContent.replace(/\{SITENAME\}/g, options.siteName);
		                  if (options.timeOut > 0) {
		                      msgContent += '<p id="ln-cancelMessage"><a href="#close" id="ln-cancelLink">Cancel</a> or press the ESC key.</p>';
		                  } else {
		                      msgContent += '<p id="ln-cancelMessage">Click the link above to continue or <a href="#close" id="ln-cancelLink">Cancel</a></p>';
		                  }
		                  $("#" + options.messageBoxId).append(msgContent);
		                  if (options.timeOut > 0) {
		                      leaveIn = setTimeout(function () {
		                          $("#ln-cancelMessage").html("<em>Loading...</em>");
		                          window.location.href = url;
		                      }, options.timeOut);
		                  } else {
		                      leaveIn = false;
		                  }
		                  if (options.newWindow) {
		                      $("a#" + options.linkId)
		                          .attr("target", "_blank")
		                          .click(function () {
		                              closeDialog(options, leaveIn);
		                          });
		                  }
		                  $("#ln-cancelLink").click(function () {
		                      closeDialog(options, leaveIn);
		                      return false;
		                  });
		                  $(document).bind("keyup", function (e) {
		                      if (e.which == 27) {
		                          closeDialog(options, leaveIn);
		                      }
		                  });
		                  $(window).unload(function () {
		                      closeDialog(options, leaveIn);
		                  });
		                  return false;
		              });
				  }
	          });
	      };
	      function closeDialog(options, timer) {
	          if (options.timeOut > 0) {
	              clearTimeout(timer);
	          }
	          $("#" + options.overlayId + ", #" + options.messageHolderId).fadeOut("fast", function () {
	              $("#" + options.overlayId + ", #" + options.messageHolderId).remove();
	          });
	          $(document).unbind("keyup");
	      }
	  })(jQuery);
	  
  	$(function(){
  	  $('a').leaveNotice();
  	});
  </script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> NIST Scan Framework For ARTIQ
          </a>
              <div class="version">
                2.0.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installing.html">Installing the NIST scan framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../scans.html">Creating scan experiments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../models.html">Using models for data processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../scans_ref.html">Scans references and API docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../models_ref.html">Models reference and API docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../analysis.html">Curve fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../applets.html">Applets</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">NIST Scan Framework For ARTIQ</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>scan_framework.scans.scan</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for scan_framework.scans.scan</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">artiq.experiment</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span><span class="p">,</span> <span class="n">sleep</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">cProfile</span><span class="o">,</span> <span class="nn">pstats</span>


<span class="c1"># allows @portable methods that use delay_mu to compile</span>
<div class="viewcode-block" id="delay_mu"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.delay_mu">[docs]</a><span class="k">def</span> <span class="nf">delay_mu</span><span class="p">(</span><span class="n">duration</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="Paused"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Paused">[docs]</a><span class="k">class</span> <span class="nc">Paused</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exception raised on the core device when a scan should either pause and yield to a higher priority experiment or</span>
<span class="sd">    should terminate.&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="FitGuess"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.FitGuess">[docs]</a><span class="k">class</span> <span class="nc">FitGuess</span><span class="p">(</span><span class="n">NumberValue</span><span class="p">):</span>
<div class="viewcode-block" id="FitGuess.__init__"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.FitGuess.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fit_param</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">param_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">i_result</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i_result</span> <span class="o">=</span> <span class="n">i_result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_param</span> <span class="o">=</span> <span class="n">fit_param</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_default</span> <span class="o">=</span> <span class="n">use_default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_index</span> <span class="o">=</span> <span class="n">param_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use</span> <span class="o">=</span> <span class="n">use</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Scan"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan">[docs]</a><span class="k">class</span> <span class="nc">Scan</span><span class="p">(</span><span class="n">HasEnvironment</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Base class for all scans. Provides a generalized framework for executing a scan.</span>
<span class="sd">    Provides dataset initialization, mutating, fitting, validation of data, pausing/resuming, and</span>
<span class="sd">    plotting of scan data.</span>

<span class="sd">    **Scan Callbacks**</span>

<span class="sd">    Various callbacks are provided that execute at certain moments of a scan&#39;s life cycle.  Using callbacks allows</span>
<span class="sd">    code in child classes to execute at predefined stages of the scan.  The following callback methods are available,</span>
<span class="sd">    listed in order of execution.  (see the &#39;Scan Callbacks&#39; section for additional information)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># -- kernel invariants</span>
    <span class="n">kernel_invariants</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;npasses&#39;</span><span class="p">,</span> <span class="s1">&#39;nbins&#39;</span><span class="p">,</span> <span class="s1">&#39;nrepeats&#39;</span><span class="p">,</span> <span class="s1">&#39;npoints&#39;</span><span class="p">,</span> <span class="s1">&#39;nmeasurements&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;do_fit&#39;</span><span class="p">,</span> <span class="s1">&#39;save_fit&#39;</span><span class="p">,</span> <span class="s1">&#39;fit_only&#39;</span><span class="p">}</span>

    <span class="c1"># ------------------- Configuration Attributes ---------------------</span>
    <span class="c1"># These are set by the child scan class to enable/disable features and control how the scan is run.</span>

    <span class="c1"># Feature: dataset mutating</span>
    <span class="n">enable_mutate</span> <span class="o">=</span> <span class="kc">True</span>          <span class="c1">#: Mutate mean values and standard errors datasets after each scan point.  Used to monitor progress of scan while it is running.</span>

    <span class="c1"># Feature: fitting</span>
    <span class="n">enable_fitting</span> <span class="o">=</span> <span class="kc">True</span>         <span class="c1">#: Set to True to perform fits at the end of the scan and show scan arguments needed for fitting.</span>

    <span class="c1"># Feature: pausing/terminating</span>
    <span class="n">enable_pausing</span> <span class="o">=</span> <span class="kc">True</span>         <span class="c1">#: Check pause via :code:`self.scheduler.check_pause()` and automatically yield/terminate the scan when needed.</span>

    <span class="c1"># Feature: count monitoring</span>
    <span class="n">enable_count_monitor</span> <span class="o">=</span> <span class="kc">True</span>   <span class="c1">#: Update the &#39;/counts&#39; dataset with the average of all values returned by &#39;measure()&#39; during a single scan point.</span>
    <span class="n">counts_perc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>              <span class="c1">#: Set to a value &gt;= 0 to round the &#39;/counts&#39; dataset to the specified number of digits.</span>

    <span class="c1"># Feature: reporting</span>
    <span class="n">enable_reporting</span> <span class="o">=</span> <span class="kc">True</span>       <span class="c1">#: Print useful information to the Log window before a scan starts (i.e. number of passes, etc.) and when a fit is performed (fitted values, etc.)</span>

    <span class="c1"># Feature: warm-up points</span>
    <span class="n">nwarmup_points</span> <span class="o">=</span> <span class="mi">0</span>            <span class="c1">#: Number of warm-up points</span>

    <span class="c1"># Feature: auto tracking</span>
    <span class="n">enable_auto_tracking</span> <span class="o">=</span> <span class="kc">True</span>   <span class="c1">#: Auto center the scan range around the last fitted value.</span>

    <span class="c1"># Feature: host scans</span>
    <span class="n">run_on_core</span> <span class="o">=</span> <span class="kc">True</span>            <span class="c1">#: Set to False to run scans entirely on the host and not on the core device.</span>

    <span class="c1"># Feature: profiling/timing</span>
    <span class="n">enable_profiling</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1">#: Profile the execution of the scan to find bottlenecks.</span>
    <span class="n">enable_timing</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1">#: Enable automatic timing of certain events.  Currently only compilation time is timed.</span>

    <span class="c1"># ------------------- Scan State Variables ---------------------</span>
    <span class="c1"># Available in callbacks to determine the current state of the scan</span>
    <span class="n">warming_up</span> <span class="o">=</span> <span class="kc">False</span>            <span class="c1">#: Used in the measure method to determine when warmup points are being run by the framework.</span>

    <span class="c1"># ------------------- Internal/Private Variables -------------------</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_logger_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_analyzed</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_fit_guesses</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">_hide_arguments</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># ------------------- Private Methods ---------------------</span>
<div class="viewcode-block" id="Scan.__init__"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">managers_or_parent</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger_name</span> <span class="o">=</span> <span class="s1">&#39;scan&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_logger</span><span class="p">()</span>

        <span class="c1"># initialize variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nmeasurements</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npoints</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1">#self.npasses = 1  #: Number of passes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npasses</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#self.nbins = 50  #: Number of histogram bins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#self.nrepeats = 1  #: Number of repeats</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nrepeats</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_x_offset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">do_fit</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1">#: Fits are performed after the scan completes.  Set automatically by scan framework from the &#39;Fit Options&#39; argument</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_fit</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1">#: Fitted params are saved to datasets.  Set automatically by scan framework from the &#39;Fit Options&#39; argument</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_only</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1">#: Scan is not run and fits are performed on data from the previous scan.  Set automatically by scan framework from the &#39;Fit Options&#39; argument</span>

        <span class="c1"># -- scan state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_paused</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1">#: scan is currently paused</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_terminated</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1">#: scan has been terminated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1">#: the current measurement</span>

        <span class="c1"># -- cass variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measurements</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1">#: List of measurements performed on each scan point</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ncalcs</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model_registry</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_shape</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_point</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_point</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tick</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_points</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_warmup_points</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warming_up</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># this stores &quot;flat&quot; idx point index when a scan is paused.  the idx index is then restored from</span>
        <span class="c1"># this variable when the scan resumes.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_i_pass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_i_measurement</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">managers_or_parent</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="c1"># private: for scan.py</span>
<div class="viewcode-block" id="Scan._profile"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan._profile">[docs]</a>    <span class="k">def</span> <span class="nf">_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_profiling</span><span class="p">:</span>
            <span class="c1"># run scan in profiler</span>
            <span class="c1">#   This is useful for tracking down bottlenecks in the host side code only.  It does not profile code</span>
            <span class="c1">#   running on the core device.</span>
            <span class="k">if</span> <span class="n">start</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pr</span> <span class="o">=</span> <span class="n">cProfile</span><span class="o">.</span><span class="n">Profile</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">stop</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_profiling</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">pstats</span><span class="o">.</span><span class="n">Stats</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">)</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">strip_dirs</span><span class="p">()</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">sort_stats</span><span class="p">(</span><span class="s1">&#39;cumulative&#39;</span><span class="p">)</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">print_stats</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span></div>

    <span class="c1"># private: for scan.py</span>
<div class="viewcode-block" id="Scan._initialize"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan._initialize">[docs]</a>    <span class="k">def</span> <span class="nf">_initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resume</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the scan&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;_initialize()&quot;</span><span class="p">)</span>

        <span class="c1"># initialize state variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_paused</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># callback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;executing prepare_scan callback&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">resume</span><span class="p">:</span>
            <span class="c1"># load scan points</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_points</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;loaded points&#39;</span><span class="p">)</span>

        <span class="c1"># this expects that self.npoints is available</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepare_scan</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lab_prepare_scan</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">resume</span><span class="p">:</span>
            <span class="c1"># display scan info</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_reporting</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># display scan info</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_reporting</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">resume</span><span class="p">:</span>

            <span class="c1"># map gui arguments to class variables</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map_arguments</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_attach_models</span><span class="p">()</span>

            <span class="c1"># there must be at least one measurement</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurements</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">measurements</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nmeasurements</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">measurements</span><span class="p">)</span>

            <span class="c1"># expects self._x_offset has been set</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_offset_points</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x_offset</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;offset points by </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x_offset</span><span class="p">))</span>

            <span class="c1"># initialize storage</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_storage</span><span class="p">()</span>

            <span class="c1"># attach scan to models (expects self.npoints has been set)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_attach_to_models</span><span class="p">()</span>

            <span class="c1"># initialize simulations (needs self._x_offset/self.frequency_center)</span>
            <span class="c1">#self._init_simulations()</span>

            <span class="c1"># display scan info</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_reporting</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>

            <span class="c1"># reset model states</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset_model_states</span><span class="p">()</span>

        <span class="c1"># callback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;executing before_scan callback&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">before_scan</span><span class="p">()</span>

        <span class="c1"># -- Initialize Datasets</span>

        <span class="c1"># these have been deprecated</span>
        <span class="c1">#init_local = not (self.fit_only or resume)</span>
        <span class="c1">#write_datasets = resume</span>
        <span class="c1">#write_done = []</span>

        <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span>
        <span class="n">plot_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_shape</span>
        <span class="n">points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_points</span>

        <span class="c1"># datasets are only initialized/written when a scan can run</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_only</span><span class="p">:</span>

            <span class="c1"># for every registered model...</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_registry</span><span class="p">:</span>
                <span class="c1"># each type (e.g. rsb, bsb, etc)</span>
                <span class="c1">#for type, entry in entries.items():</span>

                    <span class="c1"># datasets are only initialized when the scan begins</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">resume</span><span class="p">:</span>
                        <span class="c1"># initialize datasets if requested by the users</span>
                        <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;init_datasets&#39;</span><span class="p">]:</span>
                            <span class="c1"># initialize the model&#39;s datasets</span>
                            <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;datasets_initialized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">init_datasets</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">plot_shape</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">dimension</span><span class="o">=</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;dimension&#39;</span><span class="p">])</span>

                            <span class="c1"># debug logging</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;initialized datasets of model &#39;</span><span class="si">{0}</span><span class="s2">&#39; </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">entry</span><span class="p">))</span>

                            <span class="c1"># # run once</span>
                            <span class="c1"># if entry[&#39;name&#39;] in done:</span>
                            <span class="c1">#     entry[&#39;datasets_initialized&#39;] = True</span>
                            <span class="c1"># else:</span>
                            <span class="c1">#     entry[&#39;model&#39;].init_datasets(shape, plot_shape, points, dimension=entry[&#39;dimension&#39;])</span>
                            <span class="c1">#</span>
                            <span class="c1">#     # mark done</span>
                            <span class="c1">#     done.append(entry[&#39;name&#39;])</span>
                            <span class="c1">#     entry[&#39;datasets_initialized&#39;] = True</span>

                    <span class="c1"># datasets are only written when resuming a scan</span>
                    <span class="k">if</span> <span class="n">resume</span><span class="p">:</span>
                        <span class="c1"># restore data when resuming a scan by writing the model&#39;s local variables to it&#39;s datasets</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_write_datasets</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

                        <span class="c1"># debug logging</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;wrote datasets of model &#39;</span><span class="si">{0}</span><span class="s2">&#39; </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span> <span class="n">entry</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ncalcs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calculations</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;scheduler&#39;</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;The scan has no scheduler attribute.  Did you forget to call super().build()?&#39;</span><span class="p">)</span></div>

    <span class="c1"># private: for scan.py</span>
<div class="viewcode-block" id="Scan._loop"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan._loop">[docs]</a>    <span class="nd">@portable</span>
    <span class="k">def</span> <span class="nf">_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resume</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Main loop: performs measurement at each scan point and mutates datasets with measured values&quot;&quot;&quot;</span>
        <span class="n">ncalcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ncalcs</span>
        <span class="n">npoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npoints</span>
        <span class="n">nwarmup_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwarmup_points</span>
        <span class="n">nmeasurements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmeasurements</span>
        <span class="n">nrepeats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrepeats</span>
        <span class="n">measurements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurements</span>
        <span class="n">points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_points_flat</span>
        <span class="n">wupoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_warmup_points</span>
        <span class="n">i_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i_points</span>
        <span class="n">npasses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npasses</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># callback</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_before_loop</span><span class="p">(</span><span class="n">resume</span><span class="p">)</span>
            <span class="c1"># callback</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialize_devices</span><span class="p">()</span>

            <span class="c1"># iterate of passes</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i_pass</span> <span class="o">&lt;</span> <span class="n">npasses</span><span class="p">:</span>
                <span class="c1"># update offset into self.dataptr[] where data begins for this pass</span>
                <span class="n">last_pass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i_pass</span> <span class="o">==</span> <span class="n">npasses</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">poffset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i_pass</span> <span class="o">*</span> <span class="n">nrepeats</span>

                <span class="c1"># callback</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">resume</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">before_pass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_i_pass</span><span class="p">)</span>

                <span class="c1"># inner loop</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_point_loop</span><span class="p">(</span><span class="n">points</span><span class="p">,</span>
                                 <span class="n">wupoints</span><span class="p">,</span>
                                 <span class="n">i_points</span><span class="p">,</span>
                                 <span class="n">npoints</span><span class="p">,</span>
                                 <span class="n">nwarmup_points</span><span class="p">,</span>
                                 <span class="n">ncalcs</span><span class="p">,</span>
                                 <span class="n">poffset</span><span class="p">,</span>
                                 <span class="n">nrepeats</span><span class="p">,</span>
                                 <span class="n">nmeasurements</span><span class="p">,</span>
                                 <span class="n">measurements</span><span class="p">,</span>
                                 <span class="n">last_pass</span><span class="o">=</span><span class="n">last_pass</span><span class="p">)</span>

                <span class="c1"># update loop counter</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_i_pass</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># reset loop counter</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_i_pass</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">except</span> <span class="n">Paused</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_paused</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span></div>

    <span class="c1"># private: for scan.py</span>
<div class="viewcode-block" id="Scan._point_loop"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan._point_loop">[docs]</a>    <span class="nd">@portable</span>
    <span class="k">def</span> <span class="nf">_point_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">warmup_points</span><span class="p">,</span> <span class="n">i_points</span><span class="p">,</span> <span class="n">npoints</span><span class="p">,</span> <span class="n">nwarmup_points</span><span class="p">,</span> <span class="n">ncalcs</span><span class="p">,</span> <span class="n">poffset</span><span class="p">,</span> <span class="n">nrepeats</span><span class="p">,</span>
                    <span class="n">nmeasurements</span><span class="p">,</span> <span class="n">measurements</span><span class="p">,</span> <span class="n">last_pass</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># -- warm-up points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warming_up</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">wupoint</span> <span class="ow">in</span> <span class="n">warmup_points</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i_measurement</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmeasurements</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span> <span class="o">=</span> <span class="n">measurements</span><span class="p">[</span><span class="n">i_measurement</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warmup</span><span class="p">(</span><span class="n">wupoint</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warming_up</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># -- loop over the scan points</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span> <span class="o">&lt;</span> <span class="n">npoints</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># lookup the scan point (point) and the scan point index (i_point) at the current loop index (idx)</span>
            <span class="n">point</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_idx</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_i_point</span> <span class="o">=</span> <span class="n">i_points</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_idx</span><span class="p">]</span>

            <span class="c1"># repeat measurement on scan point</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_repeat_loop</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i_point</span><span class="p">,</span> <span class="n">nrepeats</span><span class="p">,</span> <span class="n">nmeasurements</span><span class="p">,</span> <span class="n">measurements</span><span class="p">,</span> <span class="n">poffset</span><span class="p">,</span> <span class="n">ncalcs</span><span class="p">,</span>
                              <span class="n">last_point</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">last_pass</span><span class="o">=</span><span class="n">last_pass</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># last scan point is special (optimization)</span>
        <span class="n">point</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">npoints</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_i_point</span> <span class="o">=</span> <span class="n">i_points</span><span class="p">[</span><span class="n">npoints</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_repeat_loop</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i_point</span><span class="p">,</span> <span class="n">nrepeats</span><span class="p">,</span> <span class="n">nmeasurements</span><span class="p">,</span> <span class="n">measurements</span><span class="p">,</span> <span class="n">poffset</span><span class="p">,</span> <span class="n">ncalcs</span><span class="p">,</span>
                          <span class="n">last_point</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">last_pass</span><span class="o">=</span><span class="n">last_pass</span><span class="p">)</span>

        <span class="c1"># -- reset loop counter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span> <span class="o">=</span> <span class="mi">0</span></div>

    <span class="c1"># private: for scan.py</span>
<div class="viewcode-block" id="Scan._repeat_loop"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan._repeat_loop">[docs]</a>    <span class="nd">@portable</span>
    <span class="k">def</span> <span class="nf">_repeat_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">i_point</span><span class="p">,</span> <span class="n">nrepeats</span><span class="p">,</span> <span class="n">nmeasurements</span><span class="p">,</span> <span class="n">measurements</span><span class="p">,</span> <span class="n">poffset</span><span class="p">,</span> <span class="n">ncalcs</span><span class="p">,</span>
                     <span class="n">last_point</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">last_pass</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="c1"># check for higher priority experiment or termination requested</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_pausing</span><span class="p">:</span>

            <span class="c1"># cost: 3.6 ms</span>
            <span class="n">check_pause</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">check_pause</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">check_pause</span><span class="p">:</span>
                <span class="c1"># yield</span>
                <span class="k">raise</span> <span class="n">Paused</span>

        <span class="c1"># dynamically offset the scan point</span>
        <span class="n">point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset_point</span><span class="p">(</span><span class="n">i_point</span><span class="p">,</span> <span class="n">point</span><span class="p">)</span>

        <span class="c1"># callback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_scan_point</span><span class="p">(</span><span class="n">i_point</span><span class="p">,</span> <span class="n">point</span><span class="p">)</span>

        <span class="c1"># iterate over repeats</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i_repeat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrepeats</span><span class="p">):</span>
            <span class="c1"># iterate over measurements</span>
            <span class="k">for</span> <span class="n">i_measurement</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmeasurements</span><span class="p">):</span>
                <span class="c1"># so other methods know what the current measurement is</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span> <span class="o">=</span> <span class="n">measurements</span><span class="p">[</span><span class="n">i_measurement</span><span class="p">]</span>

                <span class="c1"># callback</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">before_measure</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lab_before_measure</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="p">)</span>

                <span class="c1"># perform a single measurement and store the result</span>
                <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_measure</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_idx</span><span class="p">][</span><span class="n">i_measurement</span><span class="p">][</span><span class="n">poffset</span> <span class="o">+</span> <span class="n">i_repeat</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span>
                <span class="n">counts</span> <span class="o">+=</span> <span class="n">count</span>

                <span class="c1"># callback</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">after_measure</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lab_after_measure</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span><span class="p">)</span>

        <span class="c1"># update the dataset used to monitor counts</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">counts</span> <span class="o">/</span> <span class="p">(</span><span class="n">nrepeats</span><span class="o">*</span><span class="n">nmeasurements</span><span class="p">)</span>

        <span class="c1"># cost: 18 ms per point</span>
        <span class="c1"># mutate dataset values</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_mutate</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_i_pass</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">nrepeats</span>
            <span class="k">for</span> <span class="n">i_measurement</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmeasurements</span><span class="p">):</span>
                <span class="c1"># get data for model</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_idx</span><span class="p">][</span><span class="n">i_measurement</span><span class="p">][:</span><span class="n">length</span><span class="p">]</span>

                <span class="c1"># get the name of the measurement</span>
                <span class="n">measurement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurements</span><span class="p">[</span><span class="n">i_measurement</span><span class="p">]</span>

                <span class="c1"># rpc to host</span>
                <span class="c1"># send data to the model</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mutate_datasets</span><span class="p">(</span><span class="n">i_point</span><span class="p">,</span> <span class="n">measurement</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="c1"># self._logger.info(&quot;i_pass = &quot;)</span>
            <span class="c1"># self._logger.info(i_pass)</span>
            <span class="c1"># self._logger.info(&quot;idx = &quot;)</span>
            <span class="c1"># self._logger.info(idx)</span>

        <span class="c1"># perform calculations</span>
        <span class="k">if</span> <span class="n">ncalcs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># rpc to host</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_all</span><span class="p">(</span><span class="n">i_point</span><span class="p">,</span> <span class="n">point</span><span class="p">)</span>

        <span class="c1"># analyze data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_data</span><span class="p">(</span><span class="n">i_point</span><span class="p">,</span> <span class="n">last_pass</span><span class="p">,</span> <span class="n">last_point</span><span class="p">)</span>

        <span class="c1"># callback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">after_scan_point</span><span class="p">(</span><span class="n">i_point</span><span class="p">,</span> <span class="n">point</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_after_scan_point</span><span class="p">(</span><span class="n">i_point</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">mean</span><span class="p">)</span>

        <span class="c1"># rpc to host</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_count_monitor</span><span class="p">:</span>
            <span class="c1"># cost: 2.7 ms</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_counts</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span></div>

    <span class="c1"># private: for scan.py</span>
<div class="viewcode-block" id="Scan.map_arguments"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.map_arguments">[docs]</a>    <span class="k">def</span> <span class="nf">map_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Map coarse grained attributes to fine grained options.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_fitting</span><span class="p">:</span>
            <span class="c1"># defaults</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_fit</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_fit</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fit_only</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;fit_options&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_options</span> <span class="o">==</span> <span class="s1">&#39;No Fits&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">do_fit</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">save_fit</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fit_only</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_options</span> <span class="o">==</span> <span class="s1">&#39;Fit&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">do_fit</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">save_fit</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fit_only</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_options</span> <span class="o">==</span> <span class="s1">&#39;Fit and Save&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">do_fit</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">save_fit</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fit_only</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_options</span> <span class="o">==</span> <span class="s1">&#39;Fit Only&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">do_fit</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">save_fit</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fit_only</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_options</span> <span class="o">==</span> <span class="s1">&#39;Fit Only and Save&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">do_fit</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">save_fit</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fit_only</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_map_arguments</span><span class="p">()</span></div>

    <span class="c1"># private: for scan.py</span>
<div class="viewcode-block" id="Scan._init_storage"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan._init_storage">[docs]</a>    <span class="k">def</span> <span class="nf">_init_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;initialize memory to record counts on core device&quot;&quot;&quot;</span>

        <span class="c1">#: 3D array of counts measured at each scan point, measurement, pass, and repeat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span>
                <span class="p">[</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nrepeats</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">npasses</span><span class="p">)</span>
                <span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmeasurements</span><span class="p">)</span>
            <span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npoints</span><span class="p">)</span>
        <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;initialized storage&#39;</span><span class="p">)</span></div>

    <span class="c1"># private: for scan.py</span>
<div class="viewcode-block" id="Scan._attach_to_models"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan._attach_to_models">[docs]</a>    <span class="k">def</span> <span class="nf">_attach_to_models</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Attach the scan to all models&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_registry</span><span class="p">):</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_attach_to_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;attached scan to model &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]))</span></div>

    <span class="c1"># private: for scan.py</span>
<div class="viewcode-block" id="Scan._attach_to_model"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan._attach_to_model">[docs]</a>    <span class="k">def</span> <span class="nf">_attach_to_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Attach the scan to a single model.</span>
<span class="sd">        Allows passing scan variables to the model at runtime&quot;&quot;&quot;</span>
        <span class="n">model</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

    <span class="c1"># private: for scan.py</span>
<div class="viewcode-block" id="Scan._attach_models"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan._attach_models">[docs]</a>    <span class="k">def</span> <span class="nf">_attach_models</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Attach a single model to the scan&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__load_x_offset</span><span class="p">()</span></div>

    <span class="c1"># private: for scan.py</span>
    <span class="k">def</span> <span class="nf">__load_x_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_x_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_x_offset</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_offset</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;set _x_offset to </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x_offset</span><span class="p">))</span>

    <span class="c1"># private: for scan.py</span>
    <span class="k">def</span> <span class="nf">__get_x_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># offset has been manually set by the user:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_offset</span>
        <span class="c1"># automatic determination of x_offset:</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_auto_tracking</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_registry</span><span class="p">:</span>
                    <span class="n">model</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="s1">&#39;auto_track&#39;</span> <span class="ow">in</span> <span class="n">entry</span> <span class="ow">and</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;auto_track&#39;</span><span class="p">]:</span>
                        <span class="c1"># use the last performed fit</span>
                        <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;auto_track&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fitresults&#39;</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;fit&#39;</span><span class="p">):</span>
                            <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="o">.</span><span class="n">fitresults</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">main_fit</span><span class="p">]</span>
                        <span class="c1"># use dataset value</span>
                        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;auto_track&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fit&#39;</span> <span class="ow">or</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;auto_track&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">get_main_fit</span><span class="p">(</span><span class="n">archive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># default to no offset if none of the above cases apply</span>
        <span class="k">return</span> <span class="mf">0.0</span>

    <span class="c1"># private: for scan.py</span>
<div class="viewcode-block" id="Scan._init_simulations"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan._init_simulations">[docs]</a>    <span class="k">def</span> <span class="nf">_init_simulations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_registry</span><span class="p">:</span>
            <span class="c1"># measurement models...</span>
            <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;measurement&#39;</span><span class="p">]:</span>
                <span class="c1"># make a copy of simulation args to speed up simulations (don&#39;t have to recompute at each scan point)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_simulation_args</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">simulation_args</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;initialized model </span><span class="si">{0}</span><span class="s1"> simulation args to </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span>
                                                                                            <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_simulation_args</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;initialized simulations&#39;</span><span class="p">)</span></div>

    <span class="c1"># private: for scan.py</span>
<div class="viewcode-block" id="Scan.reset_model_states"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.reset_model_states">[docs]</a>    <span class="k">def</span> <span class="nf">reset_model_states</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># every registered model...</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_registry</span><span class="p">:</span>
            <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reset_state</span><span class="p">()</span></div>

    <span class="c1"># private: for scan.py</span>
<div class="viewcode-block" id="Scan._init_model_datasets"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan._init_model_datasets">[docs]</a>    <span class="k">def</span> <span class="nf">_init_model_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">plot_shape</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">init_local</span><span class="p">,</span> <span class="n">write_datasets</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the contents and handling modes of all datasets in the scan.&quot;&quot;&quot;</span></div>

    <span class="c1"># RPC</span>
    <span class="c1"># private: for scan.py</span>
<div class="viewcode-block" id="Scan._timeit"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan._timeit">[docs]</a>    <span class="k">def</span> <span class="nf">_timeit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;compile&#39;</span><span class="p">:</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_profile_times</span><span class="p">[</span><span class="s1">&#39;before_compile&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;core scan compiled in </span><span class="si">{0}</span><span class="s1"> sec&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">elapsed</span><span class="p">))</span></div>

    <span class="c1"># private: for scan.py</span>
<div class="viewcode-block" id="Scan._rewind"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan._rewind">[docs]</a>    <span class="nd">@portable</span>
    <span class="k">def</span> <span class="nf">_rewind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_points</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rewind the cursor from the current pass and point indices by the specified number of points.  The cursor can</span>
<span class="sd">          be rewound into a previous pass.  The cursor cannot be rewound past the first point of the first pass.</span>

<span class="sd">          :param num_points: The current cursor will be moved to this number of scan points before its current value.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># get new i_point, i_pass indices</span>
        <span class="k">if</span> <span class="n">num_points</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span> <span class="o">-=</span> <span class="n">num_points</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i_pass</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_i_pass</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npoints</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span></div>

    <span class="c1"># private: for scan.py</span>
<div class="viewcode-block" id="Scan._calculate"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan._calculate">[docs]</a>    <span class="k">def</span> <span class="nf">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_point</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">calculation</span><span class="p">,</span> <span class="n">entry</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform calculations on collected data after each scan point&quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">mutate_datasets_calc</span><span class="p">(</span><span class="n">i_point</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">calculation</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;mutate_plot&#39;</span> <span class="ow">in</span> <span class="n">entry</span> <span class="ow">and</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;mutate_plot&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mutate_plot</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">i_point</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>

    <span class="c1"># ------------------- Interface Methods ---------------------</span>

    <span class="c1"># interface: for child class (optional)</span>
<div class="viewcode-block" id="Scan.build"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.build">[docs]</a>    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Interface method (optional, has default behavior)</span>

<span class="sd">        Creates the :code:`scheduler` and :code:`core` devices and sets them to the attributes</span>
<span class="sd">        :code:`self.scheduler` and :code:`self.core` respectively.</span>

<span class="sd">        :param kwargs: Optional dictionary of class attributes when using the scan as a sub-component (i.e. the</span>
<span class="sd">                       scan does not inherit from :code:`EnvExperiment`).  Each entry will be set as an attribute of the scan.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># devices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setattr_device</span><span class="p">(</span><span class="s1">&#39;scheduler&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setattr_device</span><span class="p">(</span><span class="s2">&quot;core&quot;</span><span class="p">)</span></div>

    <span class="c1"># helper: for child class (optional)</span>
<div class="viewcode-block" id="Scan.run"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resume</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper method</span>

<span class="sd">        Initializes the scan, executes the scan, yields to higher priority experiments,</span>
<span class="sd">        and performs fits on completion on the scan.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># start the profiler (if it&#39;s enabled)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_profile</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># initialize the scan</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initialize</span><span class="p">(</span><span class="n">resume</span><span class="p">)</span>

            <span class="c1"># run the scan</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_only</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">resume</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s1">&#39;resuming scan at (i_pass, i_point) = (</span><span class="si">{0}</span><span class="s1">, </span><span class="si">{1}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_i_pass</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i_point</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s1">&#39;starting scan at (i_pass, i_point) = (</span><span class="si">{0}</span><span class="s1">, </span><span class="si">{1}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_i_pass</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i_point</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_on_core</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_timing</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_profile_times</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;before_compile&#39;</span><span class="p">:</span> <span class="n">time</span><span class="p">()</span>
                        <span class="p">}</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;compiling core scan...&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_run_scan_core</span><span class="p">(</span><span class="n">resume</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_run_scan_host</span><span class="p">(</span><span class="n">resume</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;scan completed&quot;</span><span class="p">)</span>

                <span class="c1"># yield to other experiments</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_paused</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_yield</span><span class="p">()</span>  <span class="c1"># self.run(resume=True) is called after other experiments finish and this scan resumes</span>
                    <span class="k">return</span>

            <span class="c1"># callback</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;executing _after_scan callback&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_after_scan</span><span class="p">():</span>
                <span class="k">return</span>

            <span class="c1"># callback</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;executing after_scan callback&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">after_scan</span><span class="p">()</span>

            <span class="c1"># perform fits</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;executing _analyze&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_analyze</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">after_analyze</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lab_after_analyze</span><span class="p">()</span>

            <span class="c1"># callback</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;executing lab_after_scan callback&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lab_after_scan</span><span class="p">()</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># stop the profiler (if it&#39;s enabled)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_profile</span><span class="p">(</span><span class="n">stop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

        <span class="c1"># callback with default behavior: for child class</span>

    <span class="c1"># interface: for child class or extension (required)</span>
<div class="viewcode-block" id="Scan.get_scan_points"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.get_scan_points">[docs]</a>    <span class="k">def</span> <span class="nf">get_scan_points</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Interface method (required - except when inheriting from TimeFreqScan, TimeScan, or FreqScan)</span>

<span class="sd">        Returns the set of scan points that will be iterated over during the scan.</span>
<span class="sd">        See the _point_loop() method</span>

<span class="sd">        :returns: The list of scan points to scan over.</span>
<span class="sd">        :rtype:  A Python list or an ARTIQ Scannable type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;The get_scan_points() method needs to be implemented.&#39;</span><span class="p">)</span></div>

    <span class="c1"># interface: for child class (optional)</span>
<div class="viewcode-block" id="Scan.get_warmup_points"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.get_warmup_points">[docs]</a>    <span class="k">def</span> <span class="nf">get_warmup_points</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Interface method (optional, has default behavior)</span>

<span class="sd">        Returns the set of warm-up points that will be iterated before scanning over the scan points.</span>

<span class="sd">        :returns: The list of warm-up points.</span>
<span class="sd">        :rtype:  A Python list or an ARTIQ Scannable type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwarmup_points</span><span class="p">)]</span></div>

    <span class="c1"># interface: for child class (optional)</span>
<div class="viewcode-block" id="Scan.create_logger"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.create_logger">[docs]</a>    <span class="k">def</span> <span class="nf">create_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Interface method (optional, has default behavior)</span>

<span class="sd">        Sets self.logger to an instance of a python logging.logger for writing log messages</span>
<span class="sd">        to the log window in the dashboard.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">logging</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;scan_framework.scans.scan&quot;</span><span class="p">)</span></div>

    <span class="c1"># interface: for child class</span>
<div class="viewcode-block" id="Scan.report"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.report">[docs]</a>    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Interface method (optional, has default behavior)</span>

<span class="sd">        Logs details about the scan to the log window.</span>
<span class="sd">        Runs during initialization after the scan points and warmup points have been loaded but before datasets</span>
<span class="sd">        have been initialized.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="s1">&#39;top&#39;</span> <span class="ow">or</span> <span class="n">location</span> <span class="o">==</span> <span class="s1">&#39;both&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npasses</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrepeats</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;START </span><span class="si">{}</span><span class="s1"> / </span><span class="si">{}</span><span class="s1"> pass / </span><span class="si">{}</span><span class="s1"> repeat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npasses</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrepeats</span><span class="p">))</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrepeats</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;START </span><span class="si">{}</span><span class="s1"> / </span><span class="si">{}</span><span class="s1"> pass / </span><span class="si">{}</span><span class="s1"> repeats&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npasses</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrepeats</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;START </span><span class="si">{}</span><span class="s1"> / </span><span class="si">{}</span><span class="s1"> passes / </span><span class="si">{}</span><span class="s1"> repeats&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npasses</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrepeats</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="s1">&#39;bottom&#39;</span> <span class="ow">or</span> <span class="n">location</span> <span class="o">==</span> <span class="s1">&#39;both&#39;</span><span class="p">:</span>
            <span class="c1"># self.logger.info(&#39;Passes: %i&#39; % self.npasses)</span>
            <span class="c1"># self.logger.info(&#39;Repeats: %i&#39; % self.nrepeats)</span>
            <span class="c1"># self.logger.info(&#39;Bins: %i&#39; % self.nbins)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;do_fit </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">do_fit</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;save_fit </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_fit</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;fit_only </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_only</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_report</span><span class="p">()</span></div>

    <span class="c1"># interface: for child class (required)</span>
<div class="viewcode-block" id="Scan.measure"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.measure">[docs]</a>    <span class="nd">@portable</span>
    <span class="k">def</span> <span class="nf">measure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Interface method  (required)</span>

<span class="sd">        Performs a single measurement and returns the result of the measurement as an integer.</span>

<span class="sd">        :param point: Current scan point value</span>
<span class="sd">        :returns: The result of a single measurement</span>
<span class="sd">        :rtype: Integer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;The measure() method needs to be implemented.&#39;</span><span class="p">)</span></div>

    <span class="c1"># interface: for child class (optional)</span>
<div class="viewcode-block" id="Scan.warmup"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.warmup">[docs]</a>    <span class="nd">@portable</span>
    <span class="k">def</span> <span class="nf">warmup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Interface method  (optional)</span>

<span class="sd">        Contains experimental code to execute at each warmup point.</span>
<span class="sd">        If this method is not implemented, each warmup point will execute the measure method.</span>

<span class="sd">        :param point: Current warmup point value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_measure</span><span class="p">(</span><span class="n">point</span><span class="p">)</span></div>

    <span class="c1"># interface: for child class (optional)</span>
<div class="viewcode-block" id="Scan.mutate_datasets"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.mutate_datasets">[docs]</a>    <span class="nd">@rpc</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;async&quot;</span><span class="p">})</span>
    <span class="k">def</span> <span class="nf">mutate_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_point</span><span class="p">,</span> <span class="n">measurement</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Interface method  (optional, has default behavior)</span>

<span class="sd">        If this method is not overridden, all data collected for the specified measurement during the</span>
<span class="sd">        current scan point is passed to any model that has been registered for the given measurement.</span>
<span class="sd">        The :code:`mutate_datasets()` and :code:`_mutate_plot()` methods of these models will be called with :code:`data`</span>
<span class="sd">        passed as an argument. Thus, the registered models will calculate means and standard errors and plot these</span>
<span class="sd">        statistics to the current scan applet for the current scan point.</span>

<span class="sd">        Typically, the default implementation of this method is used, though it can be overridden in user scans</span>
<span class="sd">        to manually perform statistic calculation and plotting of measurement data at the end of each scan point.</span>

<span class="sd">        Notes</span>
<span class="sd">            - Always runs on the host device.</span>

<span class="sd">        :param i_point: Index of the current scan point.</span>
<span class="sd">        :param measurement: Name of the current measurement (For multiple measurements).</span>
<span class="sd">        :param point: Value of the current scan point.</span>
<span class="sd">        :param data: List of integers containing the values returned by :code:`measure()` at each repetition of the current scan point.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measurement</span> <span class="o">=</span> <span class="n">measurement</span>

        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_registry</span><span class="p">:</span>
            <span class="c1"># model registered for this measurement</span>
            <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;measurement&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;measurement&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">measurement</span><span class="p">:</span>
                <span class="c1"># grab the model for the measurement from the registry</span>
                <span class="c1"># if measurement in self._model_registry[&#39;measurements&#39;]:</span>
                <span class="c1">#    entry = self._model_registry[&#39;measurements&#39;][measurement]</span>

                <span class="c1"># mutate the stats for this measurement with the data passed from the core device</span>
                <span class="n">mean</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mutate_datasets</span><span class="p">(</span><span class="n">i_point</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mutate_plot</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">i_point</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">mean</span><span class="p">)</span></div>

                <span class="c1"># keep a record on the host of the data collected for this pass, measurement, and scan point</span>
                <span class="c1"># for i_repetition in range(len(data)):</span>
                <span class="c1">#    self._data.set(pos=[i_measurement, i_point, i_repetition], value=np.int32(data[i_repetition]))</span>

    <span class="c1"># interface: for child class (optional)</span>
<div class="viewcode-block" id="Scan.analyze"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.analyze">[docs]</a>    <span class="k">def</span> <span class="nf">analyze</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Interface method  (optional)</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyzed</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_terminated</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_analyze</span><span class="p">()</span></div>

    <span class="c1"># interface: for child class (optional)</span>
<div class="viewcode-block" id="Scan._yield"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan._yield">[docs]</a>    <span class="k">def</span> <span class="nf">_yield</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Interface method  (optional)</span>

<span class="sd">        Yield to scheduled experiments with higher priority</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Yielding to higher priority experiment.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">pause</span><span class="p">()</span>

            <span class="c1"># resume</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Resuming&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">resume</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">TerminationRequested</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Scan terminated.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_terminated</span> <span class="o">=</span> <span class="kc">True</span></div>

    <span class="c1"># interface: for child class (optional)</span>
    <span class="c1"># RPC</span>
<div class="viewcode-block" id="Scan._set_counts"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan._set_counts">[docs]</a>    <span class="nd">@rpc</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;async&quot;</span><span class="p">})</span>
    <span class="k">def</span> <span class="nf">_set_counts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">counts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Interface method  (optional)</span>

<span class="sd">        Runs after a scan point completes.  By default, this method sets the :code:`counts` dataset</span>
<span class="sd">        to the value passed in on the :code:`counts` parameter of this method.  It therefore also</span>
<span class="sd">        updates the count monitor dataset with the average value measured at the current scan point</span>
<span class="sd">        while the scan is running.</span>

<span class="sd">        :param counts: Average value of all values returned from :code:`measure()` during the current scan point.</span>

<span class="sd">        Notes</span>
<span class="sd">            - Does not run if :code:`self.enable_count_monitor == False`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">counts_perc</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">counts</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">counts_perc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_dataset</span><span class="p">(</span><span class="s1">&#39;counts&#39;</span><span class="p">,</span> <span class="n">counts</span><span class="p">,</span> <span class="n">broadcast</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">persist</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

    <span class="c1"># interface: for child class (optional)</span>
<div class="viewcode-block" id="Scan._calculate_all"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan._calculate_all">[docs]</a>    <span class="nd">@rpc</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;async&quot;</span><span class="p">})</span>
    <span class="k">def</span> <span class="nf">_calculate_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_point</span><span class="p">,</span> <span class="n">point</span><span class="p">):</span>
        <span class="c1"># for every registered calculation....</span>
        <span class="k">for</span> <span class="n">calculation</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculations</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_registry</span><span class="p">:</span>
                <span class="c1"># models that are registered for the calculation...</span>
                <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;calculation&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;calculation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">calculation</span><span class="p">:</span>
                    <span class="c1"># entry = self._model_registry[&#39;calculations&#39;][calculation]</span>

                    <span class="c1"># perform the calculation</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">before_calculate</span><span class="p">(</span><span class="n">i_point</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">calculation</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_calculate</span><span class="p">(</span><span class="n">i_point</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">calculation</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span></div>

    <span class="c1"># interface: for child class</span>
<div class="viewcode-block" id="Scan._get_fit_guess"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan._get_fit_guess">[docs]</a>    <span class="k">def</span> <span class="nf">_get_fit_guess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fit_function</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maps GUI arguments to fit guesses.  &quot;&quot;&quot;</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">fit_function</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">args</span>
        <span class="c1"># map gui arguments to fit guesses</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_guesses</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_guesses</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;use&#39;</span><span class="p">]:</span>
                <span class="c1"># generic fit guess gui arguments specified by position in the fit function signature</span>
                <span class="k">if</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;fit_param&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;param_index&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;param_index&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">signature</span><span class="p">):</span>
                        <span class="n">g</span><span class="p">[</span><span class="s1">&#39;fit_param&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">signature</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;fit_param&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">guess</span><span class="p">[</span><span class="n">g</span><span class="p">[</span><span class="s1">&#39;fit_param&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">guess</span></div>

    <span class="c1"># interface: for child class (optional)</span>
<div class="viewcode-block" id="Scan._analyze"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan._analyze">[docs]</a>    <span class="k">def</span> <span class="nf">_analyze</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Interface method (optional, has default behavior)</span>

<span class="sd">        If this method is not overridden, fits will be performed automatically on the mean values calculated</span>
<span class="sd">        for each measurement of the scan.</span>

<span class="sd">        Calls :code:`before_analyze()`, checks to see if fits should be performed, and performs a fit using</span>
<span class="sd">        each model that has been registered as performing a fit (i.e. :code:`fit=True` when calling</span>
<span class="sd">        :code:`register_model()`).  After fits have been performed, :code:`after_fit()` and :code:`report_fit()`</span>
<span class="sd">        are called.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">before_analyze</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analyzed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># should/can fits be performed? ...</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_fit</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_fitting</span><span class="p">:</span>

            <span class="c1">#Perform a fit for each registered fit model and save the fitted params to datasets.</span>
            <span class="c1">#</span>
            <span class="c1">#If self.save_fit is true, the main fit is broadcast to the ARTIQ master,</span>
            <span class="c1">#persisted and saved.  If self.save_fit is False, the main fit is not broadcasted or persisted but is saved</span>
            <span class="c1">#so that it can still be retrieved using normal get_datset methods before the experiment has completed.</span>

            <span class="c1"># for every registered model...</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_registry</span><span class="p">:</span>
                <span class="c1"># registered fit models</span>
                <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;fit&#39;</span><span class="p">]:</span>
                    <span class="n">model</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>

                    <span class="c1"># callback</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">before_fit</span><span class="p">(</span><span class="n">model</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>

                        <span class="c1"># what&#39;s the correct data source?</span>
                        <span class="c1">#   When fitting only (no scan is performed) the fit is performed on data from the last</span>
                        <span class="c1">#   scan that ran, which is assumed to be in the &#39;current_scan&#39; namespace.</span>
                        <span class="c1">#   Otherwise, the fit is performed on data in the model&#39;s namespace.</span>
                        <span class="n">use_mirror</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">mirror</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_only</span>
                        <span class="n">save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_fit</span>

                        <span class="c1"># dummy values, these are only used in 2d scans</span>
                        <span class="n">dimension</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

                        <span class="c1"># perform the fit</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;performing fit on model </span><span class="se">\&#39;</span><span class="si">{0}</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]))</span>
                        <span class="n">fit_performed</span><span class="p">,</span> <span class="n">valid</span><span class="p">,</span> <span class="n">main_fit_saved</span><span class="p">,</span> <span class="n">errormsg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">save</span><span class="p">,</span> <span class="n">use_mirror</span><span class="p">,</span> <span class="n">dimension</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

                        <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;fit_valid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid</span>

                        <span class="c1"># tell current scan to plot data...</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;plots.trigger&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;mirror&#39;</span><span class="p">)</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;plots.trigger&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;mirror&#39;</span><span class="p">)</span>

                        <span class="c1"># params not saved warning occurred</span>
                        <span class="k">if</span> <span class="n">save</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">main_fit_saved</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Fitted params not saved.&quot;</span><span class="p">)</span>

                        <span class="c1"># callback</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_main_fit_saved</span> <span class="o">=</span> <span class="n">main_fit_saved</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_valid</span> <span class="o">=</span> <span class="n">valid</span>
                        <span class="k">if</span> <span class="n">fit_performed</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">after_fit</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;fit&#39;</span><span class="p">],</span> <span class="n">valid</span><span class="p">,</span> <span class="n">main_fit_saved</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>

                    <span class="c1"># print the fitted parameters...</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_reporting</span> <span class="ow">and</span> <span class="n">fit_performed</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">report_fit</span><span class="p">(</span><span class="n">model</span><span class="p">)</span></div>

    <span class="c1"># interface: for extensions (required)</span>
<div class="viewcode-block" id="Scan._write_datasets"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan._write_datasets">[docs]</a>    <span class="k">def</span> <span class="nf">_write_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry</span><span class="p">):</span>
        <span class="k">pass</span></div>

    <span class="c1"># interface: for extensions (required)</span>
<div class="viewcode-block" id="Scan._load_points"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan._load_points">[docs]</a>    <span class="k">def</span> <span class="nf">_load_points</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

    <span class="c1"># interface: for extensions (required)</span>
<div class="viewcode-block" id="Scan._offset_points"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan._offset_points">[docs]</a>    <span class="k">def</span> <span class="nf">_offset_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_offset</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;The _offset_points() method needs to be implemented.&#39;</span><span class="p">)</span></div>

    <span class="c1"># interface: for extensions (optional)</span>
<div class="viewcode-block" id="Scan._report"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan._report">[docs]</a>    <span class="k">def</span> <span class="nf">_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

    <span class="c1"># interface: for extensions (required)</span>
<div class="viewcode-block" id="Scan._mutate_plot"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan._mutate_plot">[docs]</a>    <span class="k">def</span> <span class="nf">_mutate_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">i_point</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mean</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

    <span class="c1"># interface: for extensions (required)</span>
<div class="viewcode-block" id="Scan.calculate_dim0"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.calculate_dim0">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_dim0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim1_model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;User callback (runs on host).</span>

<span class="sd">        Returns a value and its error from the dimension 1 sub-scan.  The returned value will be plotted</span>
<span class="sd">        as  the y-value in the dimension 0 plot and the returned error will weight the final fit along dimension 0.</span>

<span class="sd">        :param model: The model which just performed a fit along the dimension 1 sub-scan.  :code:`model.fit` points to</span>
<span class="sd">                      the :class:`Fit &lt;scan_framework.analysis.curvefits.Fit&gt;` object from the</span>
<span class="sd">                      :ref:`analysis &lt;analysisapi&gt;` package.</span>
<span class="sd">        :type model: ScanModel</span>
<span class="sd">        :returns: The calculated value and the error in the calculated value.</span>
<span class="sd">        :rtype: A two entry tuple where the first entry is the calculated value and the second entry is the error</span>
<span class="sd">                in the calculated value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

    <span class="c1"># interface: for extensions (optional)</span>
<div class="viewcode-block" id="Scan.do_measure"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.do_measure">[docs]</a>    <span class="nd">@portable</span>
    <span class="k">def</span> <span class="nf">do_measure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Provides a way for subclasses to override the method signature of the measure method.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure</span><span class="p">(</span><span class="n">point</span><span class="p">)</span></div>

    <span class="c1"># ------------------- Helper Methods ---------------------</span>
    <span class="c1"># helper: for child class</span>
<div class="viewcode-block" id="Scan.setattr_argument"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.setattr_argument">[docs]</a>    <span class="k">def</span> <span class="nf">setattr_argument</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">processor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">show</span> <span class="ow">is</span> <span class="s1">&#39;auto&#39;</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">show</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">or</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hide_arguments</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hide_arguments</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_hide_arguments</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span>

        <span class="c1"># fit guesses</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span> <span class="n">FitGuess</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">group</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">group</span> <span class="o">=</span> <span class="s1">&#39;Fit Settings&#39;</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setattr_argument</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">NumberValue</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">processor</span><span class="o">.</span><span class="n">default_value</span><span class="p">,</span>
                                                      <span class="n">ndecimals</span><span class="o">=</span><span class="n">processor</span><span class="o">.</span><span class="n">ndecimals</span><span class="p">,</span>
                                                      <span class="n">step</span><span class="o">=</span><span class="n">processor</span><span class="o">.</span><span class="n">step</span><span class="p">,</span>
                                                      <span class="n">unit</span><span class="o">=</span><span class="n">processor</span><span class="o">.</span><span class="n">unit</span><span class="p">,</span>
                                                      <span class="nb">min</span><span class="o">=</span><span class="n">processor</span><span class="o">.</span><span class="n">min</span><span class="p">,</span>
                                                      <span class="nb">max</span><span class="o">=</span><span class="n">processor</span><span class="o">.</span><span class="n">max</span><span class="p">,</span>
                                                      <span class="n">scale</span><span class="o">=</span><span class="n">processor</span><span class="o">.</span><span class="n">scale</span><span class="p">),</span> <span class="n">group</span><span class="p">)</span>
            <span class="n">use</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">processor</span><span class="o">.</span><span class="n">use</span> <span class="ow">is</span> <span class="s1">&#39;ask&#39;</span><span class="p">:</span>
                <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setattr_argument</span><span class="p">(</span><span class="s1">&#39;use_</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">BooleanValue</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">processor</span><span class="o">.</span><span class="n">use_default</span><span class="p">),</span> <span class="n">group</span><span class="p">)</span>
                <span class="n">use</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;use_</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">use</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">use</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_fit_guesses</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;fit_param&#39;</span><span class="p">:</span> <span class="n">processor</span><span class="o">.</span><span class="n">fit_param</span><span class="p">,</span>
                <span class="s1">&#39;param_index&#39;</span><span class="p">:</span> <span class="n">processor</span><span class="o">.</span><span class="n">param_index</span><span class="p">,</span>
                <span class="s1">&#39;use&#39;</span><span class="p">:</span> <span class="n">use</span><span class="p">,</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setattr_argument</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">processor</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>

        <span class="c1"># set attribute to default value when class is built but not submitted</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span> <span class="s1">&#39;default_value&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">processor</span><span class="o">.</span><span class="n">default_value</span><span class="p">)</span></div>

    <span class="c1"># helper: for child class</span>
<div class="viewcode-block" id="Scan.scan_arguments"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.scan_arguments">[docs]</a>    <span class="k">def</span> <span class="nf">scan_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">npasses</span><span class="o">=</span><span class="p">{},</span> <span class="n">nrepeats</span><span class="o">=</span><span class="p">{},</span> <span class="n">nbins</span><span class="o">=</span><span class="p">{},</span> <span class="n">fit_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">guesses</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># assign default values for scan GUI arguments</span>
        <span class="k">if</span> <span class="n">npasses</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;ndecimals&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">npasses</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nrepeats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;ndecimals&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">nrepeats</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nbins</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s1">&#39;ndecimals&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">nbins</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fit_options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;No Fits&#39;</span><span class="p">,</span><span class="s1">&#39;Fit&#39;</span><span class="p">,</span><span class="s2">&quot;Fit and Save&quot;</span><span class="p">,</span><span class="s2">&quot;Fit Only&quot;</span><span class="p">,</span><span class="s2">&quot;Fit Only and Save&quot;</span><span class="p">],</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="s1">&#39;Fit&#39;</span><span class="p">}</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">fit_options</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">npasses</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setattr_argument</span><span class="p">(</span><span class="s1">&#39;npasses&#39;</span><span class="p">,</span> <span class="n">NumberValue</span><span class="p">(</span><span class="o">**</span><span class="n">npasses</span><span class="p">),</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;Scan Settings&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nrepeats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setattr_argument</span><span class="p">(</span><span class="s1">&#39;nrepeats&#39;</span><span class="p">,</span> <span class="n">NumberValue</span><span class="p">(</span><span class="o">**</span><span class="n">nrepeats</span><span class="p">),</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;Scan Settings&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nbins</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setattr_argument</span><span class="p">(</span><span class="s1">&#39;nbins&#39;</span><span class="p">,</span> <span class="n">NumberValue</span><span class="p">(</span><span class="o">**</span><span class="n">nbins</span><span class="p">),</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;Scan Settings&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_fitting</span> <span class="ow">and</span> <span class="n">fit_options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">fovals</span> <span class="o">=</span> <span class="n">fit_options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;values&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setattr_argument</span><span class="p">(</span><span class="s1">&#39;fit_options&#39;</span><span class="p">,</span> <span class="n">EnumerationValue</span><span class="p">(</span><span class="n">fovals</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_options</span><span class="p">),</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;Fit Settings&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">guesses</span><span class="p">:</span>
                 <span class="k">if</span> <span class="n">guesses</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
                         <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;fit_guess_</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">setattr_argument</span><span class="p">(</span><span class="n">key</span><span class="p">,</span>
                                               <span class="n">FitGuess</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                                                        <span class="n">use_default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                        <span class="n">ndecimals</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
                                                        <span class="n">step</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
                                                        <span class="n">fit_param</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                        <span class="n">param_index</span><span class="o">=</span><span class="n">i</span><span class="p">))</span>
                 <span class="k">else</span><span class="p">:</span>
                     <span class="k">for</span> <span class="n">fit_param</span> <span class="ow">in</span> <span class="n">guesses</span><span class="p">:</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;fit_guess_</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fit_param</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">setattr_argument</span><span class="p">(</span><span class="n">key</span><span class="p">,</span>
                                              <span class="n">FitGuess</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                                                       <span class="n">use_default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                       <span class="n">ndecimals</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                       <span class="n">step</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
                                                       <span class="n">fit_param</span><span class="o">=</span><span class="n">fit_param</span><span class="p">,</span>
                                                       <span class="n">param_index</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scan_arguments</span><span class="p">()</span></div>

    <span class="c1"># helper: for child class</span>
<div class="viewcode-block" id="Scan.register_model"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.register_model">[docs]</a>    <span class="k">def</span> <span class="nf">register_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_instance</span><span class="p">,</span> <span class="n">measurement</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">calculation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">init_datasets</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a model with the scan.  Models can be registered as a measurement model, fit model,</span>
<span class="sd">        calculation model, or combinations of these.</span>

<span class="sd">        When registered as a measurement model, all data collected for the specified measurement is passed to the</span>
<span class="sd">        specified model instance&#39;s mutate_datasets() method via an RPC after it has been collected.</span>

<span class="sd">        When registered as a fit model, fitting will be performed by the specified model instance after the scan</span>
<span class="sd">        completes.  The model instance&#39;s fit_data(), validate_fit(), set_fits(), and save_main_fit() methods</span>
<span class="sd">        will be called.</span>

<span class="sd">        When registered as a calculation model, the specified model instance&#39;s mutate_datasets_calc() method will be</span>
<span class="sd">        called at the end of each scan point.</span>

<span class="sd">        :param model_instance: Instance of the scan model being registered</span>
<span class="sd">        :type model_instance: :class:`scan_framework.models.scan_model.ScanModel`</span>
<span class="sd">        :param measurement: The name of the measurement for which the model will calculate and save statistics.</span>
<span class="sd">                            When only a single measurement is performed by the scan, this can simply be set to True.</span>
<span class="sd">                            If not set to a string or to True, statistics will not be generated or saved. If set to</span>
<span class="sd">                            a string or True, the registered model&#39;s mutate_datasets() method will be called via an RPC after</span>
<span class="sd">                            each scan point completes.  The default behavior of this method is to calculate the</span>
<span class="sd">                            mean value measured at the scan point, calculate the standard error of this mean,</span>
<span class="sd">                            and to mutate the datasets storing these values under the model&#39;s namespace.  Additionally,</span>
<span class="sd">                            this updates the current scan applet to plot the new mean and error after each scan point</span>
<span class="sd">                            completes.  The mutate_datasets() method also mutates the &#39;counts&#39; dataset, which</span>
<span class="sd">                            stores every value measured and returned by the scan&#39;s &#39;measure()&#39; method, and optionally</span>
<span class="sd">                            mutates histogram datasets so that the histogram applets/plots are updated after each scan</span>
<span class="sd">                            point completes.  Defaults to None</span>
<span class="sd">        :type measurement: string or bool</span>
<span class="sd">        :param fit: The name of the measurement for which the model will perform fits.  When only a single measurement</span>
<span class="sd">                    is performed by the scan, this can simply be set to True.  If not set to a string or to True,</span>
<span class="sd">                    fitting will not be performed by the model.  If set to a string or True, the registered model&#39;s</span>
<span class="sd">                    fit_data() method will be called after the scan completes to perform a fit using the mean values</span>
<span class="sd">                    and standard errors stored under the model&#39;s namespace.  Typically, a model tthat is registered with</span>
<span class="sd">                    the fit argument set is also registered with the measurement set, though this is not strictly necessary</span>
<span class="sd">                    if the means and errors have been generated by some other means by the user.  Defaults to None</span>
<span class="sd">        :type fit: string or bool</span>
<span class="sd">        :param calculation: Name of a calculation that this model will perform at each scan point.  When set to</span>
<span class="sd">                            a string or to True, the model&#39;s mutate_datasets_calc() method is called after each</span>
<span class="sd">                            scan point with the calculation name passes in on the calculation argument.  The mutate_datasets_calc()</span>
<span class="sd">                            method, in turn calls the model&#39;s calculate() method which performs the calculation and</span>
<span class="sd">                            returns the calculated value along with its error.  The calculated value and its error is</span>
<span class="sd">                            then set to the datasets along with the value of the current scan point under the namespace</span>
<span class="sd">                            of the registered model.  Defaults to None</span>
<span class="sd">        :type calculation: string or bool</span>
<span class="sd">        :param init_datasets: If True, all datasets relevant to the scan are initialized under the model&#39;s namespace by</span>
<span class="sd">                            calling the model&#39;s init_datasets() method,  defaults to True</span>
<span class="sd">        :type init_datasets: bool</span>
<span class="sd">        :param validate: If True, all validation rules defined in the model will be applied to the data to be fit</span>
<span class="sd">                         and/or the fit params found by this model during fitting.  If False, no validations will be perforemd</span>
<span class="sd">                         by the model.</span>
<span class="sd">        :type validate: bool</span>
<span class="sd">        :param set: If True, all relevant data for a fit will be saved to the datasets by calling the model&#39;s set_fits() method.</span>
<span class="sd">                    The set_fits() method is only called if fits have been performed by the model.</span>
<span class="sd">        :type set: bool</span>
<span class="sd">        :param save: If True, the fit param specified by the model&#39;s &#39;main_fit&#39; attribute will be saved to the datasets</span>
<span class="sd">                     when the fitted params pass all strong validation rules defined in the model.  If no strong validation</span>
<span class="sd">                     rules are defined, the main fit param is always saved as long as the fit was performed.  If validations</span>
<span class="sd">                     are disabled, the main fit param is always saved.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># map args</span>
        <span class="k">if</span> <span class="n">calculation</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">calculation</span> <span class="o">=</span> <span class="s1">&#39;main&#39;</span>
        <span class="k">if</span> <span class="n">measurement</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">measurement</span> <span class="o">=</span> <span class="s1">&#39;main&#39;</span>
        <span class="k">if</span> <span class="n">fit</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">fit</span> <span class="o">=</span> <span class="s1">&#39;main&#39;</span>

        <span class="c1"># maintain a list of all models registered so that, later, we can dynamically bind the scan to each model</span>
        <span class="c1"># and perform any other needed model initializations (this includes calc models)</span>
        <span class="c1">#if name not in self._models:</span>
        <span class="c1">#    self._models.append(name)</span>

        <span class="c1"># maintain a dynamic registry of all model instances so they can each be called after a scan point</span>
        <span class="c1"># has completed</span>

        <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">model_instance</span><span class="p">,</span>
            <span class="s1">&#39;init_datasets&#39;</span><span class="p">:</span> <span class="n">init_datasets</span><span class="p">,</span>
            <span class="s1">&#39;datasets_initialized&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;measurement&#39;</span><span class="p">:</span> <span class="n">measurement</span><span class="p">,</span>
            <span class="s1">&#39;fit&#39;</span><span class="p">:</span> <span class="n">fit</span><span class="p">,</span>
            <span class="s1">&#39;calculation&#39;</span><span class="p">:</span> <span class="n">calculation</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">model_instance</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="p">}</span>

        <span class="c1"># tack on any additional user defined settings</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">entry</span>
        <span class="p">}</span>

        <span class="c1"># default to dimension 0 for 1D scans</span>
        <span class="k">if</span> <span class="s1">&#39;dimension&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">:</span>
            <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;dimension&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># register the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model_registry</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

        <span class="c1"># debug logging</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">measurement</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">calculation</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;registered model </span><span class="se">\&#39;</span><span class="si">{0}</span><span class="se">\&#39;</span><span class="s1"> </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">entry</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">measurement</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;registered measurement model </span><span class="se">\&#39;</span><span class="si">{0}</span><span class="se">\&#39;</span><span class="s1"> </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">entry</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">calculation</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;registered calculation model </span><span class="se">\&#39;</span><span class="si">{0}</span><span class="se">\&#39;</span><span class="s1"> </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">entry</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">fit</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;registered fit model </span><span class="se">\&#39;</span><span class="si">{0}</span><span class="se">\&#39;</span><span class="s1"> </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">entry</span><span class="p">))</span>

        <span class="c1"># auto-register calculations and measurements</span>
        <span class="k">if</span> <span class="n">calculation</span> <span class="ow">and</span> <span class="n">calculation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculations</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calculations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calculation</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">measurement</span> <span class="ow">and</span> <span class="n">measurement</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurements</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">measurements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">measurement</span><span class="p">)</span></div>

    <span class="c1"># helper method: for scan.py or child class</span>
<div class="viewcode-block" id="Scan._run_scan_core"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan._run_scan_core">[docs]</a>    <span class="nd">@kernel</span>
    <span class="k">def</span> <span class="nf">_run_scan_core</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resume</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper Method:</span>

<span class="sd">        Executes the scan on the core device.</span>
<span class="sd">        Calls :code:`lab_before_scan_core()`, then :code:`_loop()`, followed by :code:`after_scan_core()` and</span>
<span class="sd">        :code:`lab_after_scan_core()`</span>

<span class="sd">        :param resume: Set to True if the scan is being resumed after being paused and to False if the scan is being</span>
<span class="sd">                       started for the first time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_timing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timeit</span><span class="p">(</span><span class="s1">&#39;compile&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;running scan on core device&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lab_before_scan_core</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="p">(</span><span class="n">resume</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">after_scan_core</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lab_after_scan_core</span><span class="p">()</span></div>

    <span class="c1"># helper method: for scan.py or child class</span>
<div class="viewcode-block" id="Scan._run_scan_host"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan._run_scan_host">[docs]</a>    <span class="k">def</span> <span class="nf">_run_scan_host</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resume</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper Method:</span>

<span class="sd">        Executes the scan entirely on the host device.  The :code:`measure()` method of the scan must not have</span>
<span class="sd">        the @kernel decorator if this method is called or if :code:`self.run_on_core == False`</span>
<span class="sd">        Calls :code:`_loop()`</span>

<span class="sd">        :param resume: Set to True if the scan is being resumed after being paused and to False if the scan is being</span>
<span class="sd">                       started for the first time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;running scan on the host&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="p">(</span><span class="n">resume</span><span class="p">)</span></div>

    <span class="c1"># helper: for child class</span>
<div class="viewcode-block" id="Scan.simulate_measure"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.simulate_measure">[docs]</a>    <span class="k">def</span> <span class="nf">simulate_measure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">measurement</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_registry</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;measurement&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;measurement&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">measurement</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
                <span class="c1">#model = self._model_registry[&#39;measurements&#39;][measurement][&#39;model&#39;]</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;_simulation_args&#39;</span><span class="p">):</span>
                    <span class="n">simulation_args</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_simulation_args</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">simulation_args</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">simulation_args</span>
                <span class="c1"># self._logger.debug(&#39;simulating measurement&#39;)</span>
                <span class="c1"># self._logger.debug(&#39;simulation_args = {0}&#39;.format(simulation_args))</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_level</span><span class="p">,</span> <span class="n">simulation_args</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">value</span>
        <span class="k">return</span> <span class="kc">None</span></div>

    <span class="c1"># -------------------- Callbacks --------------------</span>

    <span class="c1"># -- initialization callbacks</span>

    <span class="c1"># callback: for child class</span>
<div class="viewcode-block" id="Scan.prepare_scan"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.prepare_scan">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;User callback</span>

<span class="sd">        Runs during initialization after the scan points and warmup points have been loaded</span>
<span class="sd">        but before datasets have been initialized.</span>

<span class="sd">        Notes</span>
<span class="sd">            - Will be re-run when a scan is resumed after being paused.</span>
<span class="sd">            - Always runs on the host.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="c1"># callback: for child class</span>
<div class="viewcode-block" id="Scan.lab_prepare_scan"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.lab_prepare_scan">[docs]</a>    <span class="k">def</span> <span class="nf">lab_prepare_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;User callback</span>

<span class="sd">        Runs on the host during initialization after the scan points and warmup points have been loaded</span>
<span class="sd">        but before datasets have been initialized.</span>

<span class="sd">        Meant to be implemented in a base class from which all of a lab&#39;s scans inherit.</span>

<span class="sd">        Notes</span>
<span class="sd">            - Runs after the :code:`prepare_scan()` callback.</span>
<span class="sd">            - Will be re-run when a scan is resumed after being paused.</span>
<span class="sd">            - Always runs on the host.</span>

<span class="sd">        :returns: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="c1"># callback: for child class</span>
<div class="viewcode-block" id="Scan.before_scan"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.before_scan">[docs]</a>    <span class="k">def</span> <span class="nf">before_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;User callback</span>

<span class="sd">        Run during initialization before datsets are initialized.</span>

<span class="sd">        Notes</span>
<span class="sd">            - always runs on the host</span>
<span class="sd">            - called after the &#39;prepare_scan&#39; callback</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="c1"># callback: for child class</span>
<div class="viewcode-block" id="Scan.before_analyze"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.before_analyze">[docs]</a>    <span class="k">def</span> <span class="nf">before_analyze</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;User callback</span>

<span class="sd">        Runs on the host before deciding if fits should be performed.</span>

<span class="sd">        Notes</span>
<span class="sd">            - Always runs on the host.</span>
<span class="sd">            - Will run even if fits have been disabled or performing a fit has not been selected in the GUI.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="c1"># callback reserved for child classes</span>
<div class="viewcode-block" id="Scan.initialize_devices"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.initialize_devices">[docs]</a>    <span class="nd">@portable</span>
    <span class="k">def</span> <span class="nf">initialize_devices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;User callback</span>

<span class="sd">        Typically used to initialize devices on the core device before the scan loop begins.</span>
<span class="sd">        Runs after datasets have been initialized but before the scan loop begins.</span>

<span class="sd">        Notes</span>
<span class="sd">            - runs anytime _run_scan_core() or _run_scan_host() is called</span>
<span class="sd">            - runs on the host or the core device</span>
<span class="sd">            - called after the &#39;before_scan&#39; callback</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Scan._before_loop"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan._before_loop">[docs]</a>    <span class="nd">@portable</span>
    <span class="k">def</span> <span class="nf">_before_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resume</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extension callback</span>

<span class="sd">        Called before the scan loop begins.</span>
<span class="sd">            - called after initialize_devices()</span>
<span class="sd">            - runs on the host or the core device</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="c1"># callback: for child class</span>
<div class="viewcode-block" id="Scan.before_pass"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.before_pass">[docs]</a>    <span class="nd">@portable</span>
    <span class="k">def</span> <span class="nf">before_pass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_pass</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;User callback</span>

<span class="sd">        Runs during the scan loop at the start of each pass.</span>

<span class="sd">        Notes</span>
<span class="sd">            - Does not run when the scan is resumed from being paused unless no scan points have yet executed.</span>
<span class="sd">            - Runs on the host or the core device.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="c1"># callback: for child class</span>
<div class="viewcode-block" id="Scan.offset_point"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.offset_point">[docs]</a>    <span class="nd">@portable</span>
    <span class="k">def</span> <span class="nf">offset_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_point</span><span class="p">,</span> <span class="n">point</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;User callback</span>

<span class="sd">        Allows scan points to be dynamically modified in a scan.  The value returned by this method</span>
<span class="sd">        is used as the current scan point.  Runs before measurements are repeated at the current scan point.</span>

<span class="sd">        :param i_point: Index of the current scan point.</span>
<span class="sd">        :param point: Value of the scan point that will be executed next.</span>
<span class="sd">        :returns: Possibly modified value of the scan point that will be executed next.</span>
<span class="sd">        :rtype: Same datatype as a single scan point</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">point</span></div>

    <span class="c1"># callback: for child class</span>
<div class="viewcode-block" id="Scan.set_scan_point"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.set_scan_point">[docs]</a>    <span class="nd">@portable</span>
    <span class="k">def</span> <span class="nf">set_scan_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_point</span><span class="p">,</span> <span class="n">point</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;User callback</span>

<span class="sd">        Callback to set device parameter values (e.g. DDS frequencies) at the start of a scan point</span>
<span class="sd">        before the :code:`measure()` method is repeated self.nrepeats times at the current scan point.</span>
<span class="sd">        Runs during the scan loop at the start of each scan point.</span>

<span class="sd">        Notes</span>
<span class="sd">            - Runs on the host or the core device.</span>
<span class="sd">            - Runs before the &#39;before_measure&#39; callback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="c1"># callback: for child class</span>
<div class="viewcode-block" id="Scan.before_measure"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.before_measure">[docs]</a>    <span class="nd">@portable</span>
    <span class="k">def</span> <span class="nf">before_measure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">measurement</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;User callback</span>

<span class="sd">        Runs at each repetition of a scan point immediately before the :code:`measure()` method is called.</span>

<span class="sd">        Notes</span>
<span class="sd">            - Runs on the host or the core device.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="c1"># callback: for child class</span>
<div class="viewcode-block" id="Scan.lab_before_measure"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.lab_before_measure">[docs]</a>    <span class="nd">@portable</span>
    <span class="k">def</span> <span class="nf">lab_before_measure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">measurement</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;User callback</span>

<span class="sd">        Runs at each repetition of a scan point immediately before the :code:`measure()` method is called.</span>

<span class="sd">        Meant to be implemented in a base class from which all of a lab&#39;s scans inherit.</span>

<span class="sd">        Notes</span>
<span class="sd">            - Runs on the host or the core device.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="c1"># callback: for child class</span>
<div class="viewcode-block" id="Scan.after_measure"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.after_measure">[docs]</a>    <span class="nd">@portable</span>
    <span class="k">def</span> <span class="nf">after_measure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">measurement</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;User callback</span>

<span class="sd">        Runs at each repetition of a scan point immediately after the :code:`measure()` method is called.</span>

<span class="sd">        Notes</span>
<span class="sd">            - Runs on the host or the core device.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="c1"># callback: for child class</span>
<div class="viewcode-block" id="Scan.lab_after_measure"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.lab_after_measure">[docs]</a>    <span class="nd">@portable</span>
    <span class="k">def</span> <span class="nf">lab_after_measure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">measurement</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;User callback</span>

<span class="sd">        Runs at each repetition of a scan point immediately after the :code:`measure()` method is called.</span>

<span class="sd">        Meant to be implemented in a base class from which all of a lab&#39;s scans inherit.</span>

<span class="sd">        Notes</span>
<span class="sd">            - Runs on the host or the core device.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="c1"># callback: for child class</span>
<div class="viewcode-block" id="Scan.before_calculate"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.before_calculate">[docs]</a>    <span class="k">def</span> <span class="nf">before_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_point</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">calculation</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;User callback</span>

<span class="sd">        Runs during the scan loop after all data has been collected for a scan point but before calculations</span>
<span class="sd">        are performed.  Must return True for calculations to be performed.</span>

<span class="sd">        Notes</span>
<span class="sd">            - Always runs on the host.</span>
<span class="sd">            - Calculations will always run if this callback is not implemented.</span>
<span class="sd">            - Return False to skip calculations for the current scan point.</span>
<span class="sd">            - Return True to allow calculations to execute for the current scan point.</span>
<span class="sd">            - Runs before the :code:`after_scan_point()` callback</span>

<span class="sd">        :param i_point: Index of the current scan point.</span>
<span class="sd">        :param point: Value of the current scan point.</span>
<span class="sd">        :param calculation: Name of the calculation to perform.</span>
<span class="sd">        :returns: True: The calculation will be performed.  False: The calculation will not be performed.</span>
<span class="sd">        :rtype: Boolean</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span></div>

    <span class="c1"># callback: for child class</span>
<div class="viewcode-block" id="Scan.after_scan_point"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.after_scan_point">[docs]</a>    <span class="nd">@portable</span>
    <span class="k">def</span> <span class="nf">after_scan_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_point</span><span class="p">,</span> <span class="n">point</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;User callback</span>

<span class="sd">        Runs during the scan loop after a scan point has completed.</span>

<span class="sd">        Notes</span>
<span class="sd">            - Run on host or core device.</span>
<span class="sd">            - Run after all data has been collected, datasets have been mutated, and 2 have run for</span>
<span class="sd">              a scan point.</span>
<span class="sd">            - Runs after the :code:`before_calculate()` callback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="c1"># -- finalization &amp; analysis callbacks</span>

    <span class="c1"># callback: for child class</span>
<div class="viewcode-block" id="Scan.cleanup"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.cleanup">[docs]</a>    <span class="nd">@portable</span>
    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;User callback</span>

<span class="sd">        This callback is meant to perform cleanup on the core device after a scan completes.  For</span>
<span class="sd">        example, resetting DDS frequencies or DAC values that have changed during the scan back to</span>
<span class="sd">        their appropriate default values.</span>
<span class="sd">        Called after the scan has completed and before data is fit.</span>

<span class="sd">        Notes</span>
<span class="sd">            - Runs on host or core device.</span>
<span class="sd">            - Called before the :code:`after_scan()` and the :code:`after_scan_core()` callbacks.</span>
<span class="sd">            - Always called before yielding to higher priority experiment.</span>
<span class="sd">            - This callback will still execute if an exception is thrown during the scan loop.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="c1"># callback: for child class</span>
<div class="viewcode-block" id="Scan.after_scan_core"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.after_scan_core">[docs]</a>    <span class="nd">@kernel</span>
    <span class="k">def</span> <span class="nf">after_scan_core</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;User callback</span>

<span class="sd">        Runs on the core device after the scan and any higher priority experiments have completed.</span>

<span class="sd">        Notes</span>
<span class="sd">            - Always runs on the core device.</span>
<span class="sd">            - Runs before data is fit.</span>
<span class="sd">            - This callback will not be called before yielding to higher priority experiment.</span>
<span class="sd">            - This callback will not be called if the scan is terminated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="c1"># callback: for child class</span>
<div class="viewcode-block" id="Scan.lab_after_scan_core"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.lab_after_scan_core">[docs]</a>    <span class="nd">@kernel</span>
    <span class="k">def</span> <span class="nf">lab_after_scan_core</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;User callback</span>

<span class="sd">        Runs on the core device after the scan and any higher priority experiments have completed.</span>

<span class="sd">        Meant to be implemented in a base class from which all of a lab&#39;s scans inherit.</span>

<span class="sd">        Notes</span>
<span class="sd">            - Always runs on the core device.</span>
<span class="sd">            - Runs before data is fit.</span>
<span class="sd">            - This callback will not be called before yielding to higher priority experiment.</span>
<span class="sd">            - This callback will not be called if the scan is terminated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="c1"># callback: for child class</span>
<div class="viewcode-block" id="Scan.lab_before_scan_core"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.lab_before_scan_core">[docs]</a>    <span class="nd">@kernel</span>
    <span class="k">def</span> <span class="nf">lab_before_scan_core</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;User callback</span>

<span class="sd">        Runs on the core device after datasets have been initialized but before the scan loop begins.</span>

<span class="sd">        Meant to be implemented in a base class from which all of a lab&#39;s scans inherit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="c1"># callback: for child class</span>
<div class="viewcode-block" id="Scan._after_scan"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan._after_scan">[docs]</a>    <span class="k">def</span> <span class="nf">_after_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal callback called after the scan and any higher priority experiments have completed.</span>
<span class="sd">            - always runs on the host</span>
<span class="sd">            - runs before data is fit</span>
<span class="sd">            - this callback will not be called before yielding to higher priority experiment</span>
<span class="sd">            - this callback will not be called if scan is terminated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span></div>

    <span class="c1"># callback: for child class</span>
<div class="viewcode-block" id="Scan.after_scan"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.after_scan">[docs]</a>    <span class="k">def</span> <span class="nf">after_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;User callback</span>

<span class="sd">        Runs on the host after the scan and any higher priority experiments have completed.</span>

<span class="sd">        Notes</span>
<span class="sd">            - Always runs on the host.</span>
<span class="sd">            - Runs before data is fit.</span>
<span class="sd">            - This callback will not be called before yielding to higher priority experiment.</span>
<span class="sd">            - This callback will not be called if scan is terminated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Scan.after_analyze"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.after_analyze">[docs]</a>    <span class="k">def</span> <span class="nf">after_analyze</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;User callback</span>

<span class="sd">        Runs on the host after the scan and any higher priority experiments have completed and after analysis</span>
<span class="sd">        (e.g. fitting) has been completed.</span>

<span class="sd">        Notes</span>
<span class="sd">            - always runs on the host</span>
<span class="sd">            - runs after data is fit</span>
<span class="sd">            - runs regardless of if the fit was successful</span>
<span class="sd">            - this callback will not be called before yielding to higher priority experiment</span>
<span class="sd">            - this callback will not be called if scan is terminated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Scan.lab_after_analyze"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.lab_after_analyze">[docs]</a>    <span class="k">def</span> <span class="nf">lab_after_analyze</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;User callback</span>

<span class="sd">        Runs on the host after the scan and any higher priority experiments have completed and after analysis</span>
<span class="sd">        (e.g. fitting) has been completed.</span>

<span class="sd">        Meant to be implemented in a base class from which all of a lab&#39;s scans inherit.</span>

<span class="sd">        Notes</span>
<span class="sd">            - always runs on the host</span>
<span class="sd">            - runs after data is fit</span>
<span class="sd">            - runs regardless of if the fit was successful</span>
<span class="sd">            - this callback will not be called before yielding to higher priority experiment</span>
<span class="sd">            - this callback will not be called if scan is terminated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="c1"># callback: for child class</span>
<div class="viewcode-block" id="Scan.before_fit"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.before_fit">[docs]</a>    <span class="k">def</span> <span class="nf">before_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;User callback</span>

<span class="sd">        Runs on the host before a fit is performed by a registered fit model.</span>

<span class="sd">        Notes</span>
<span class="sd">            - Always runs on the host.</span>
<span class="sd">            - Will not run if fitting has been disable or has not been selected in the GUI.</span>

<span class="sd">        :param model: Instance of the registered fit model.</span>
<span class="sd">        :type model: ScanModel</span>
<span class="sd">        :returns: False to prevent the fit from being performed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="c1"># callback: for child class</span>
<div class="viewcode-block" id="Scan.after_fit"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.after_fit">[docs]</a>    <span class="k">def</span> <span class="nf">after_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fit_name</span><span class="p">,</span> <span class="n">valid</span><span class="p">,</span> <span class="n">saved</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;User callback</span>

<span class="sd">        Runs on the host after each registered fit model (i.e. all models registered with</span>
<span class="sd">        :code:`self.register_model(..., fit=&#39;&lt;fit name&#39;&gt;`) has performed it&#39;s fit.</span>

<span class="sd">        Notes</span>
<span class="sd">            - :code:`model.fit` is used in this callback to access the</span>
<span class="sd">              :class:`Fit &lt;scan_framework.analysis.curvefits.Fit&gt;` object containing the fitted parameters and other</span>
<span class="sd">              useful information about the fit.</span>
<span class="sd">            - Always runs on the host.</span>
<span class="sd">            - Will not run if fit&#39;s are not performed for any reason</span>

<span class="sd">        :param fit_name: The name of the fit passed in on the :code:`fit` argument of :code:`register_model()`</span>
<span class="sd">        :param valid: False if any fit validation errors were raised during fitting.</span>
<span class="sd">        :param saved: True if the :code:`main_fit` fit parameter was saved to the model&#39;s top level namespace.</span>
<span class="sd">                      (a.k.a fits were saved)</span>
<span class="sd">        :param model: Instance of the registered fit model.</span>
<span class="sd">        :type model: ScanModel</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="c1"># callback: for child class</span>
<div class="viewcode-block" id="Scan.report_fit"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.report_fit">[docs]</a>    <span class="k">def</span> <span class="nf">report_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;User callback (has default behavior)</span>

<span class="sd">        If this method is not implemented :code:`model.report_fit()` will be called, which prints useful information</span>
<span class="sd">        about the fit (i.e. the fitted parameter values) to the Log window in the dashboard.</span>

<span class="sd">        Runs on the host after each registered fit model (i.e. all models registered with</span>
<span class="sd">        :code:`self.register_model(..., fit=&#39;&lt;fit name&#39;&gt;`) has performed it&#39;s fit.</span>

<span class="sd">        Notes</span>
<span class="sd">            - Always runs on the host.</span>
<span class="sd">            - Will not run if fits are not performed for any reason.</span>

<span class="sd">        :param model: Instance of the registered fit model.</span>
<span class="sd">        :type model: ScanModel</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model</span><span class="o">.</span><span class="n">report_fit</span><span class="p">()</span></div>

    <span class="c1"># callback: for child class</span>
<div class="viewcode-block" id="Scan.lab_after_scan"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan.lab_after_scan">[docs]</a>    <span class="k">def</span> <span class="nf">lab_after_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;User callback</span>

<span class="sd">        Runs on the host after the scan has completed, fits have been performed, and any higher priority experiments</span>
<span class="sd">        have completed.</span>

<span class="sd">        Meant to be implemented in a base class from which all of a lab&#39;s scans inherit.</span>

<span class="sd">        Notes</span>
<span class="sd">            - Always runs on the host.</span>
<span class="sd">            - Runs after data is fit.</span>
<span class="sd">            - This callback will not be called before yielding to higher priority experiment.</span>
<span class="sd">            - This callback will not be called if scan is terminated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="c1"># -- callbacks for extensions</span>

    <span class="c1"># callback: for extensions</span>
<div class="viewcode-block" id="Scan._scan_arguments"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan._scan_arguments">[docs]</a>    <span class="k">def</span> <span class="nf">_scan_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

    <span class="c1"># callback: for extensions</span>
<div class="viewcode-block" id="Scan._map_arguments"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan._map_arguments">[docs]</a>    <span class="k">def</span> <span class="nf">_map_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

    <span class="c1"># callback: for extensions</span>
<div class="viewcode-block" id="Scan._after_scan_point"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan._after_scan_point">[docs]</a>    <span class="nd">@portable</span>
    <span class="k">def</span> <span class="nf">_after_scan_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_point</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">mean</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Scan extension callback executed during the scan loop after a scan point has completed.</span>
<span class="sd">            - executes on the core device</span>
<span class="sd">            - executes after all data has been collected, datasets have been mutated, calculations have been performed,</span>
<span class="sd">              and data has been analyzed.</span>

<span class="sd">        :param i_point: point index (integer for 1D scans, a list of two inetegers for 2D scans)</span>
<span class="sd">        :param point: the scan point (float for 1D scans, a list of two integers for 2D scans)</span>
<span class="sd">        :param mean: the mean number of counts collected at the scan point over all measurements.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="c1"># callback: for extensions</span>
<div class="viewcode-block" id="Scan._analyze_data"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan._analyze_data">[docs]</a>    <span class="nd">@portable</span>
    <span class="k">def</span> <span class="nf">_analyze_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_point</span><span class="p">,</span> <span class="n">last_pass</span><span class="p">,</span> <span class="n">last_point</span><span class="p">):</span>
        <span class="k">pass</span></div></div>


<div class="viewcode-block" id="Scan1D"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan1D">[docs]</a><span class="k">class</span> <span class="nc">Scan1D</span><span class="p">(</span><span class="n">Scan</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extension of the :class:`~scan_framework.scans.scan.Scan` class for 1D scans.  All 1D scans should inherit from</span>
<span class="sd">    this class.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Scan1D.__init__"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan1D.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">managers_or_parent</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">managers_or_parent</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dim</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_i_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scan1D._load_points"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan1D._load_points">[docs]</a>    <span class="k">def</span> <span class="nf">_load_points</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># grab the points</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_points</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">points</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_scan_points</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">points</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_points</span><span class="p">)</span>

        <span class="c1"># warmup points</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_warmup_points</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warmup_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_warmup_points</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warmup_points</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_warmup_points</span><span class="p">)</span>
        <span class="n">warmup_points</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">warmup_points</span><span class="p">]</span>

        <span class="c1"># this turn&#39;s ARTIQ scan arguments into lists</span>
        <span class="n">points</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points</span><span class="p">]</span>

        <span class="c1"># total number of scan points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nwarmup_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">warmup_points</span><span class="p">))</span>

        <span class="c1"># initialize shapes (these are the authority on data structure sizes)...</span>

        <span class="c1"># shape of the stats.counts dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npoints</span><span class="p">)</span>

        <span class="c1"># shape of the plots.x, plots.y, and plots.fitline datasets</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npoints</span><span class="p">)</span>

        <span class="c1"># initialize 1D data structures...</span>

        <span class="c1"># 1D array of scan points (these are saved to the stats.points dataset)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="c1"># flattened 1D array of scan points (these are looped over on the core)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_points_flat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_warmup_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">warmup_points</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="c1"># flattened 1D array of point indices as tuples</span>
        <span class="c1"># (these are used on the core to map the flat idx index to the 2D point index)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_i_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npoints</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scan1D._mutate_plot"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan1D._mutate_plot">[docs]</a>    <span class="k">def</span> <span class="nf">_mutate_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">i_point</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">mean</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>

        <span class="c1"># mutate plot x/y datasets</span>
        <span class="n">model</span><span class="o">.</span><span class="n">mutate_plot</span><span class="p">(</span><span class="n">i_point</span><span class="o">=</span><span class="n">i_point</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">point</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">mean</span><span class="p">)</span>

        <span class="c1"># tell the current_scan applet to redraw itself</span>
        <span class="n">model</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;plots.trigger&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;mirror&#39;</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;plots.trigger&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;mirror&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scan1D._fit"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan1D._fit">[docs]</a>    <span class="k">def</span> <span class="nf">_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">save</span><span class="p">,</span> <span class="n">use_mirror</span><span class="p">,</span> <span class="n">dimension</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform the fit&quot;&quot;&quot;</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
        <span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_fit_data</span><span class="p">(</span><span class="n">use_mirror</span><span class="p">)</span>

        <span class="c1"># for validation methods</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_point</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_point</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x_data</span><span class="p">)</span>

        <span class="n">errors</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">stat_model</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">mirror</span><span class="o">=</span><span class="n">use_mirror</span><span class="p">)</span>
        <span class="n">fit_function</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit_function</span>

        <span class="n">guess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fit_guess</span><span class="p">(</span><span class="n">fit_function</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">fit_data</span><span class="p">(</span>
            <span class="n">x_data</span><span class="o">=</span><span class="n">x_data</span><span class="p">,</span>
            <span class="n">y_data</span><span class="o">=</span><span class="n">y_data</span><span class="p">,</span>
            <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">,</span>
            <span class="n">fit_function</span><span class="o">=</span><span class="n">fit_function</span><span class="p">,</span>
            <span class="n">guess</span><span class="o">=</span><span class="n">guess</span><span class="p">,</span>
            <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="nb">set</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># keep a record of the fit</span>
            <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span>  <span class="c1"># save the main fit to the root namespace?</span>
            <span class="n">man_bounds</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">man_bounds</span><span class="p">,</span>
            <span class="n">man_scale</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">man_scale</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="Scan1D._offset_points"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan1D._offset_points">[docs]</a>    <span class="k">def</span> <span class="nf">_offset_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_offset</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x_offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_points</span> <span class="o">+=</span> <span class="n">x_offset</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_points_flat</span> <span class="o">+=</span> <span class="n">x_offset</span></div>

<div class="viewcode-block" id="Scan1D._write_datasets"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan1D._write_datasets">[docs]</a>    <span class="k">def</span> <span class="nf">_write_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry</span><span class="p">):</span>
        <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">write_datasets</span><span class="p">(</span><span class="n">dimension</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;datasets_written&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></div></div>


<div class="viewcode-block" id="Scan2D"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan2D">[docs]</a><span class="k">class</span> <span class="nc">Scan2D</span><span class="p">(</span><span class="n">Scan</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extension of the :class:`~scan_framework.scans.scan.Scan` class for 2D scans.  All 2D scans should inherit from</span>
<span class="sd">        this class.&quot;&quot;&quot;</span>
    <span class="n">hold_plot</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="Scan2D.__init__"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan2D.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">managers_or_parent</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">managers_or_parent</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dim</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_i_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span></div>

    <span class="c1"># private: for scan.py</span>
<div class="viewcode-block" id="Scan2D._load_points"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan2D._load_points">[docs]</a>    <span class="k">def</span> <span class="nf">_load_points</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># grab the points...</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_points</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">points</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_scan_points</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">points</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_points</span><span class="p">)</span>

        <span class="c1"># warmup points</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_warmup_points</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warmup_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_warmup_points</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warmup_points</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_warmup_points</span><span class="p">)</span>
        <span class="n">warmup_points</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">warmup_points</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_warmup_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">warmup_points</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nwarmup_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">warmup_points</span><span class="p">))</span>

        <span class="c1"># this turn&#39;s ARTIQ scan arguments into lists</span>
        <span class="n">points</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

        <span class="c1"># total number of scan points over both dimensions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="c1"># initialize shapes (these are the authority on data structure sizes)...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

        <span class="c1"># shape of the current scan plot</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

        <span class="c1"># initialize 2D data structures...</span>

        <span class="c1"># 2D array of scan points (these are saved to the stats.points dataset)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[[</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x2</span> <span class="ow">in</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">x1</span> <span class="ow">in</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="c1"># flattened 1D array of scan points (these are looped over on the core)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_points_flat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x1</span> <span class="ow">in</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x2</span> <span class="ow">in</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="c1"># flattened 1D array of point indices as tuples</span>
        <span class="c1"># (these are used on the core to map the flat idx index to the 2D point index)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_i_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">)</span> <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scan2D._mutate_plot"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan2D._mutate_plot">[docs]</a>    <span class="k">def</span> <span class="nf">_mutate_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">i_point</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">mean</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Mutates datasets for dimension 0 plots and dimension 1 plots&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;dimension&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">dim1_model</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
            <span class="n">dim1_scan_end</span> <span class="o">=</span> <span class="n">i_point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">dim1_scan_begin</span> <span class="o">=</span> <span class="n">i_point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i_point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">dim1_model</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;plots.subplot.i_plot&#39;</span><span class="p">,</span> <span class="n">i_point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;mirror&#39;</span><span class="p">,</span> <span class="n">broadcast</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">persist</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># --- Beginning of dimension 1 scan ---</span>
            <span class="c1">#if dim1_scan_begin:</span>
                <span class="c1">#if not self.hold_plot:</span>
                    <span class="c1"># clear out plot data from previous dimension 1 plots</span>
                <span class="c1">#    dim1_model.init_plots(dimension=1)</span>


            <span class="c1"># --- Mutate Dimension 1 Plot ---</span>

            <span class="c1"># first store the point &amp; mean to the dim1 plot x/y datasets</span>
            <span class="c1"># the value of the fitted parameter is plotted as the y value</span>
            <span class="c1"># at the current dimension-0 x value (i.e. x0)</span>
            <span class="n">dim1_model</span><span class="o">.</span><span class="n">mutate_plot</span><span class="p">(</span><span class="n">i_point</span><span class="o">=</span><span class="n">i_point</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>



            <span class="c1"># --- End of dimension 1 scan ---</span>
            <span class="k">if</span> <span class="n">dim1_scan_end</span><span class="p">:</span>

                <span class="c1"># --- Fit dimension 1 data ---</span>
                <span class="c1"># perform a fit over the dimension 1 data</span>
                <span class="n">fit_performed</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fit_performed</span><span class="p">,</span> <span class="n">fit_valid</span><span class="p">,</span> <span class="n">saved</span><span class="p">,</span> <span class="n">errormsg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span>
                                                                              <span class="n">save</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                                              <span class="n">use_mirror</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                                              <span class="n">dimension</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                              <span class="n">i</span><span class="o">=</span><span class="n">i_point</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                <span class="c1"># handle cases when fit fails to converge so the scan doesn&#39;t just halt entirely with an</span>
                <span class="c1"># unhandeled error</span>
                <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                    <span class="n">fit_performed</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">fit_valid</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">saved</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">errormsg</span> <span class="o">=</span> <span class="s1">&#39;Runtime Error&#39;</span>

                <span class="c1"># fit went ok...</span>
                <span class="k">if</span> <span class="n">fit_performed</span><span class="p">:</span>

                    <span class="c1"># --- Plot Dimension 1 Fitline ---</span>
                    <span class="c1"># set the fitline to the dimension 1 plot dataset</span>
                    <span class="n">dim1_model</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="s1">&#39;plots.dim1.fitline&#39;</span><span class="p">,</span> <span class="p">((</span><span class="n">i_point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">i_point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dim1_model</span><span class="o">.</span><span class="n">fit</span><span class="o">.</span><span class="n">fitline</span><span class="p">))),</span> <span class="n">dim1_model</span><span class="o">.</span><span class="n">fit</span><span class="o">.</span><span class="n">fitline</span><span class="p">)</span>

                    <span class="c1"># --- Mutate Dimension 0 Plot ---</span>

                    <span class="c1"># get the name of the fitted parameter that will be plotted</span>
                    <span class="n">param</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_dim0</span><span class="p">(</span><span class="n">dim1_model</span><span class="p">)</span>

                    <span class="c1"># find the dimension 0 model</span>
                    <span class="k">for</span> <span class="n">entry2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_registry</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">entry2</span><span class="p">[</span><span class="s1">&#39;dimension&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">dim0_model</span> <span class="o">=</span> <span class="n">entry2</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>

                            <span class="c1"># mutate the dimension 0 plot</span>
                            <span class="n">dim0_model</span><span class="o">.</span><span class="n">mutate_plot</span><span class="p">(</span><span class="n">i_point</span><span class="o">=</span><span class="n">i_point</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">param</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">error</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># --- Redraw Plots ---</span>
            <span class="c1"># tell the current_scan applet to redraw itself</span>
            <span class="n">dim1_model</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;plots.trigger&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;mirror&#39;</span><span class="p">)</span>
            <span class="n">dim1_model</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;plots.trigger&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;mirror&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scan2D._fit"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan2D._fit">[docs]</a>    <span class="k">def</span> <span class="nf">_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">save</span><span class="p">,</span> <span class="n">use_mirror</span><span class="p">,</span> <span class="n">dimension</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Performs fits on dimension 0 and dimension 1&quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
        <span class="c1"># dimension 1 fits</span>
        <span class="k">if</span> <span class="n">dimension</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># perform a fit on the completed dim1 plot and mutate the dim0 x/y datasets</span>

            <span class="c1"># get the x/y data for the fit on dimension 1</span>
            <span class="n">x_data</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">stat_model</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># these are unsorted</span>
            <span class="n">y_data</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">stat_model</span><span class="o">.</span><span class="n">means</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>

            <span class="c1"># use the errors in the dimension 1 mean values (std dev of mean) as the weights in the fit</span>
            <span class="n">errors</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">stat_model</span><span class="o">.</span><span class="n">errors</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>

            <span class="c1"># default fit arguments</span>
            <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;validate&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;set&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;save&#39;</span><span class="p">:</span> <span class="kc">False</span>
            <span class="p">}</span>
            <span class="n">guess</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># dimension 0 fits</span>
        <span class="k">elif</span> <span class="n">dimension</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># get the x/y data for the fit on dimension 0</span>
            <span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_plot_data</span><span class="p">(</span><span class="n">mirror</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># default fit arguments</span>
            <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;validate&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;set&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;save&#39;</span><span class="p">:</span> <span class="n">save</span>
            <span class="p">}</span>
            <span class="n">i</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">guess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fit_guess</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">fit_function</span><span class="p">)</span>

        <span class="c1"># settings in &#39;entry&#39; always override default values</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">defaults</span><span class="p">,</span> <span class="o">**</span><span class="n">entry</span><span class="p">}</span>

        <span class="c1"># perform the fit</span>
        <span class="n">fit_function</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit_function</span>
        <span class="n">validate</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;validate&#39;</span><span class="p">]</span>
        <span class="nb">set</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;set&#39;</span><span class="p">]</span>  <span class="c1"># save all info about the fit (fitted params, etc) to the &#39;fits&#39; namespace?</span>
        <span class="n">save</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;save&#39;</span><span class="p">]</span>  <span class="c1"># save the main fit to the root namespace?</span>
        <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">fit_data</span><span class="p">(</span>
            <span class="n">x_data</span><span class="o">=</span><span class="n">x_data</span><span class="p">,</span>
            <span class="n">y_data</span><span class="o">=</span><span class="n">y_data</span><span class="p">,</span>
            <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">,</span>
            <span class="n">fit_function</span><span class="o">=</span><span class="n">fit_function</span><span class="p">,</span>
            <span class="n">guess</span><span class="o">=</span><span class="n">guess</span><span class="p">,</span>
            <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
            <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="p">,</span>
            <span class="nb">set</span><span class="o">=</span><span class="nb">set</span><span class="p">,</span>
            <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span>
            <span class="n">man_bounds</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">man_bounds</span><span class="p">,</span>
            <span class="n">man_scale</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">man_scale</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Scan2D._offset_points"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan2D._offset_points">[docs]</a>    <span class="k">def</span> <span class="nf">_offset_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_points</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_points_flat</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">offset</span></div>

<div class="viewcode-block" id="Scan2D._write_datasets"><a class="viewcode-back" href="../../../scans/api.html#scan_framework.scans.scan.Scan2D._write_datasets">[docs]</a>    <span class="k">def</span> <span class="nf">_write_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry</span><span class="p">):</span>
        <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">write_datasets</span><span class="p">(</span><span class="n">dimension</span><span class="o">=</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;dimension&#39;</span><span class="p">])</span>
        <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;datasets_written&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></div></div>


<span class="c1"># NOTE: MetaScan has been deprecated by Scan2D</span>
<span class="k">class</span> <span class="nc">MetaScan</span><span class="p">(</span><span class="n">Scan1D</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Support for 2D scan of scan.  A top level scan is defined by inheriting from MetaScan.  That top level scan then</span>
<span class="sd">    executes a separate 1D scan that inherits from Scan1D.&quot;&quot;&quot;</span>
    <span class="n">scan_registry</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># dictionary containing instance of sub-scans that will be run by the top-level scan.</span>

    <span class="k">def</span> <span class="nf">register_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">enable_pausing</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a sub scan.  By registering a scan, it&#39;s prepare(), _initialize_scan(), and prepare_scan() methods</span>
<span class="sd">        will automatically be called immediately before those methods are called on the top level scan.</span>
<span class="sd">        Scan&#39;s must be registered in the build method of the top level scan.</span>
<span class="sd">        :param scan: Instance of the scan to register</span>
<span class="sd">        :param name: Name of the scan to register, must be unique.</span>
<span class="sd">        :param enable_pausing: pausing/terminating sub-scans does not work with the current scan architecture,</span>
<span class="sd">        it is recommended to keep this set to False.  This will override the enable_pausing attribute of the passed</span>
<span class="sd">        in scan instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_registry</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Cannot register the scan named &#39;</span><span class="si">{0}</span><span class="s2">&#39; the name has already been used.  &quot;</span>
                                <span class="s2">&quot;You must pick a unique name to register this scan under.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="n">scan</span><span class="o">.</span><span class="n">enable_pausing</span> <span class="o">=</span> <span class="n">enable_pausing</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scan_registry</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">scan</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;registered scan </span><span class="se">\&#39;</span><span class="si">{0}</span><span class="se">\&#39;</span><span class="s1"> of type </span><span class="se">\&#39;</span><span class="si">{1}</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">scan</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Cannot register scan.  The name argument is required.&quot;</span><span class="p">)</span>

    <span class="c1"># prepare sub scans</span>
    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">prepare</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_registry</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;calling </span><span class="se">\&#39;</span><span class="si">{0}</span><span class="s1">.prepare()</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="n">s</span><span class="o">.</span><span class="n">prepare</span><span class="p">()</span>

    <span class="c1"># sub scans are always initialized before top level scan</span>
    <span class="k">def</span> <span class="nf">_initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resume</span><span class="p">):</span>
        <span class="c1"># initialize sub scans</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_registry</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;calling </span><span class="se">\&#39;</span><span class="si">{0}</span><span class="s1">.initialize()</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="n">s</span><span class="o">.</span><span class="n">_initialize</span><span class="p">(</span><span class="n">resume</span><span class="p">)</span>

        <span class="c1"># initialize top level scan</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_initialize</span><span class="p">(</span><span class="n">resume</span><span class="p">)</span>

    <span class="c1"># sub scans are always prepared before top level scan</span>
    <span class="k">def</span> <span class="nf">prepare_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># prepare sub scans</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_registry</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;calling </span><span class="se">\&#39;</span><span class="si">{0}</span><span class="s1">.prepare_scan()</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="n">s</span><span class="o">.</span><span class="n">prepare_scan</span><span class="p">()</span>

        <span class="c1"># prepare top level scan</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">prepare_scan</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>