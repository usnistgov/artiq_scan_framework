<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Performing calculations &mdash; NIST Scan Framework For ARTIQ 2.1.0 documentation</title><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Running warmup points" href="warmup_points.html" />
    <link rel="prev" title="Performing multiple measurements" href="multiple_measurements.html" /> 
<script async type="text/javascript" id="_fed_an_ua_tag" src="https://dap.digitalgov.gov/Universal-Federated-Analytics-Min.js?agency=NIST&subagency=github&pua=UA-66610693-1&yt=true&exts=ppsx,pps,f90,sch,rtf,wrl,txz,m1v,xlsm,msi,xsd,f,tif,eps,mpg,xml,pl,xlt,c">
</script>
  <link rel="stylesheet" href="https://pages.nist.gov/nist-header-footer/css/nist-combined.css">  
  <script src="https://pages.nist.gov/nist-header-footer/js/nist-header-footer.js" type="text/javascript" defer="defer"></script>
  <!--<script type="text/javascript" src="https://pages.nist.gov/leaveNotice/js/jquery.leaveNotice-nist.min.js"></script>-->
  <link rel="stylesheet" type="text/css" href="https://pages.nist.gov/leaveNotice/css/jquery.leaveNotice.css" />  
  <script type="text/javascript">
	  function link_is_external(link_element) {
	      return (link_element.host !== window.location.host);
	  }
	  (function ($) {
	      $.fn.leaveNotice = function (opt) {
	          var defaults = {
	              siteName: "NIST",
	              exitMessage:
	                  "<h2><strong>Thank you for visiting {SITENAME}.</strong></h2><p>We hope your visit was informative.</p><p>We have provided this link to a non-NIST site because it has information that may be of interest to our users. NIST does not necessarily endorse the views expressed or the facts presented on this site. Further, NIST does not endorse any commercial products that may be advertised or available on this site.</p>",
	              preLinkMessage: "<div class='setoff'><p>You will now be directed to:<br/>{URL}</p></div>",
	              linkString: "",
	              newWindow: false,
	              timeOut: 1e4,
	              overlayId: "ln-blackout",
	              messageBoxId: "ln-messageBox",
	              messageHolderId: "ln-messageHolder",
	              linkId: "ln-link",
	              displayUrlLength: 50,
	              overlayAlpha: 0.3,
	          };
	          var options = $.extend(defaults, opt);
	          return this.each(function () {
				  if(link_is_external(this)) {
		              el = $(this);
					  $(this).unbind();
		              var url = el.attr("href");
		              var ulen = options.displayUrlLength;
		              if (url.length >= ulen) {
		                  var suffix = "...";
		              } else {
		                  var suffix = "";
		              }
		              var shortUrl = url.substr(0, ulen) + suffix;
		              var title = el.attr("title");
		              if (title === undefined || title == "") {
		                  var linkText = shortUrl;
		              } else {
		                  var linkText = title;
		              }
		              options.timeOut = options.newWindow ? 0 : options.timeOut;
		              el.click(function (event) {
						  event.preventDefault();
		                  $("body").append('<div id="' + options.overlayId + '"></div>');
		                  $("body").append('<div id="' + options.messageHolderId + '"><div id="' + options.messageBoxId + '"></div></div>');
		                  if (options.overlayAlpha !== false) {
		                      $("#" + options.overlayId).css("opacity", options.overlayAlpha);
		                  }
		                  preFilteredContent = options.exitMessage + options.preLinkMessage;
		                  msgContent = preFilteredContent.replace(/\{URL\}/g, '<a id="' + options.linkId + '" href="' + url + '" title="' + url + '"' + options.linkString + ">" + linkText + "</a>");
		                  msgContent = msgContent.replace(/\{SITENAME\}/g, options.siteName);
		                  if (options.timeOut > 0) {
		                      msgContent += '<p id="ln-cancelMessage"><a href="#close" id="ln-cancelLink">Cancel</a> or press the ESC key.</p>';
		                  } else {
		                      msgContent += '<p id="ln-cancelMessage">Click the link above to continue or <a href="#close" id="ln-cancelLink">Cancel</a></p>';
		                  }
		                  $("#" + options.messageBoxId).append(msgContent);
		                  if (options.timeOut > 0) {
		                      leaveIn = setTimeout(function () {
		                          $("#ln-cancelMessage").html("<em>Loading...</em>");
		                          window.location.href = url;
		                      }, options.timeOut);
		                  } else {
		                      leaveIn = false;
		                  }
		                  if (options.newWindow) {
		                      $("a#" + options.linkId)
		                          .attr("target", "_blank")
		                          .click(function () {
		                              closeDialog(options, leaveIn);
		                          });
		                  }
		                  $("#ln-cancelLink").click(function () {
		                      closeDialog(options, leaveIn);
		                      return false;
		                  });
		                  $(document).bind("keyup", function (e) {
		                      if (e.which == 27) {
		                          closeDialog(options, leaveIn);
		                      }
		                  });
		                  $(window).unload(function () {
		                      closeDialog(options, leaveIn);
		                  });
		                  return false;
		              });
				  }
	          });
	      };
	      function closeDialog(options, timer) {
	          if (options.timeOut > 0) {
	              clearTimeout(timer);
	          }
	          $("#" + options.overlayId + ", #" + options.messageHolderId).fadeOut("fast", function () {
	              $("#" + options.overlayId + ", #" + options.messageHolderId).remove();
	          });
	          $(document).unbind("keyup");
	      }
	  })(jQuery);
	  
  	$(function(){
  	  $('a').leaveNotice();
  	});
  </script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> NIST Scan Framework For ARTIQ
          </a>
              <div class="version">
                2.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installing.html">Installing the NIST scan framework</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../scans.html">Creating scan experiments</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="getting_started.html">Getting Started with Scans</a></li>
<li class="toctree-l2"><a class="reference internal" href="statistics.html">Processing and handling of scan data</a></li>
<li class="toctree-l2"><a class="reference internal" href="core_features.html">Core scan features</a></li>
<li class="toctree-l2"><a class="reference internal" href="auto_tracking.html">Relative scan ranges and auto tracking</a></li>
<li class="toctree-l2"><a class="reference internal" href="time_freq_scans.html">Time &amp; frequency scans</a></li>
<li class="toctree-l2"><a class="reference internal" href="multiple_measurements.html">Performing multiple measurements</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Performing calculations</a></li>
<li class="toctree-l2"><a class="reference internal" href="warmup_points.html">Running warmup points</a></li>
<li class="toctree-l2"><a class="reference internal" href="monitor_histograms.html">Monitor histograms</a></li>
<li class="toctree-l2"><a class="reference internal" href="2d_scans.html">2D Scans</a></li>
<li class="toctree-l2"><a class="reference internal" href="lost_ion.html">Lost ion detection and reloading</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../models.html">Using models for data processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scans_ref.html">Scans references and API docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../models_ref.html">Models reference and API docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../analysis.html">Curve fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../applets.html">Applets</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">NIST Scan Framework For ARTIQ</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../scans.html">Creating scan experiments</a> &raquo;</li>
      <li>Performing calculations</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/scans/calculations.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="performing-calculations">
<h1>Performing calculations<a class="headerlink" href="#performing-calculations" title="Permalink to this headline">¶</a></h1>
<p>Calculations can be performed and written to datasets after each scan point.  To use calculations, create a model
for the calculation and register it with the scan with the name <code class="code docutils literal notranslate"><span class="pre">calc_model</span></code> (or simple assign <code class="code docutils literal notranslate"><span class="pre">self.calc_model</span></code>
to the model instance in your scan).  After each scan point, a method named <code class="code docutils literal notranslate"><span class="pre">calculate()</span></code> which you define in the
model will be called and passed the index of the current scan point.  The <code class="code docutils literal notranslate"><span class="pre">calculate()</span></code> method must then return a
tuple of (value, error) which is the calculated value and it’s error.  Datasets under the calc model’s namespace and
the mirror namespace will be mutated with these calculated values after each scan point.  See
<code class="code docutils literal notranslate"><span class="pre">scans/heating_rate_scan.py</span></code> and <code class="code docutils literal notranslate"><span class="pre">lib/models/heating_rate.py</span></code> for examples.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scan_framework.scans</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">scan_framework.models</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">class</span> <span class="nc">CalculationScan</span><span class="p">(</span><span class="n">Scan1D</span><span class="p">,</span> <span class="n">EnvExperiment</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_model</span><span class="p">(</span><span class="n">RsbScanModel</span><span class="p">(),</span> <span class="n">measurement</span><span class="o">=</span><span class="s1">&#39;bsb&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_model</span><span class="p">(</span><span class="n">BsbScanModel</span><span class="p">(),</span> <span class="n">measurement</span><span class="o">=</span><span class="s1">&#39;rsb&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_model</span><span class="p">(</span><span class="n">BkgdScanModel</span><span class="p">(),</span> <span class="n">measurement</span><span class="o">=</span><span class="s1">&#39;bkgd&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_model</span><span class="p">(</span><span class="n">NbarScanModel</span><span class="p">(),</span> <span class="n">calculation</span><span class="o">=</span><span class="s1">&#39;nbar&#39;</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="s1">&#39;nbar&#39;</span><span class="p">,</span> <span class="n">mutate_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">RsbScanModel</span><span class="p">(</span><span class="n">TimeModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Heating Rate RSB Model&quot;&quot;&quot;</span>

    <span class="c1"># datasets</span>
    <span class="n">namespace</span> <span class="o">=</span> <span class="s1">&#39;heating_rate.rsb.%type&#39;</span>  <span class="c1">#: Dataset namespace</span>
    <span class="n">mirror</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">persist</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">broadcast</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># stats</span>
    <span class="n">enable_histograms</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">to_scan</span> <span class="o">=</span> <span class="s1">&#39;wait_time&#39;</span>

    <span class="c1"># fits</span>
    <span class="n">main_fit</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">fit_function</span> <span class="o">=</span> <span class="n">fit_functions</span><span class="o">.</span><span class="n">Exp</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">simulation_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_scan</span> <span class="o">==</span> <span class="s1">&#39;wait_time&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span>
                <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">200</span><span class="o">*</span><span class="n">us</span><span class="p">),</span>
                <span class="s1">&#39;y0&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_scan</span> <span class="o">==</span> <span class="s1">&#39;rf_amplitude&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span>
                <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;y0&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
            <span class="p">}</span>

    <span class="c1"># plots</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x_label</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_scan</span> <span class="o">==</span> <span class="s1">&#39;wait_time&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;wait time&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_scan</span> <span class="o">==</span> <span class="s1">&#39;rf_amplitude&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;rf amplitude&#39;</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x_units</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_scan</span> <span class="o">==</span> <span class="s1">&#39;wait_time&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;us&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_scan</span> <span class="o">==</span> <span class="s1">&#39;rf_amplitude&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_scan</span> <span class="o">==</span> <span class="s1">&#39;wait_time&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span><span class="o">*</span><span class="n">us</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_scan</span> <span class="o">==</span> <span class="s1">&#39;rf_amplitude&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">plot_title</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_scan</span> <span class="o">==</span> <span class="s1">&#39;wait_time&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;rsb vs wait time&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_scan</span> <span class="o">==</span> <span class="s1">&#39;rf_amplitude&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;rsb vs rf amplitude&#39;</span>


<span class="k">class</span> <span class="nc">BsbScanModel</span><span class="p">(</span><span class="n">TimeModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Heating Rate BSB Data Model &quot;&quot;&quot;</span>

    <span class="c1"># datasets</span>
    <span class="n">namespace</span> <span class="o">=</span> <span class="s1">&#39;heating_rate.bsb.%type&#39;</span>  <span class="c1">#: Dataset namespace</span>
    <span class="n">persist</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">broadcast</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">mirror</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">to_scan</span> <span class="o">=</span> <span class="s1">&#39;wait_time&#39;</span>

    <span class="c1"># stats</span>
    <span class="n">enable_histograms</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># fits</span>
    <span class="n">fit_function</span> <span class="o">=</span> <span class="n">fit_functions</span><span class="o">.</span><span class="n">Exp</span>
    <span class="n">main_fit</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">scan</span> <span class="o">=</span> <span class="s1">&#39;wait_time&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">simulation_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_scan</span> <span class="o">==</span> <span class="s1">&#39;wait_time&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">200</span> <span class="o">*</span> <span class="n">us</span><span class="p">),</span>
                <span class="s1">&#39;y0&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_scan</span> <span class="o">==</span> <span class="s1">&#39;rf_amplitude&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;y0&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
            <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x_label</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_scan</span> <span class="o">==</span> <span class="s1">&#39;wait_time&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;wait time&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_scan</span> <span class="o">==</span> <span class="s1">&#39;rf_amplitude&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;rf amplitude&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x_units</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_scan</span> <span class="o">==</span> <span class="s1">&#39;wait_time&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;us&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_scan</span> <span class="o">==</span> <span class="s1">&#39;rf_amplitude&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_scan</span> <span class="o">==</span> <span class="s1">&#39;wait_time&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">us</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_scan</span> <span class="o">==</span> <span class="s1">&#39;rf_amplitude&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">plot_title</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_scan</span> <span class="o">==</span> <span class="s1">&#39;wait_time&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;bsb&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_scan</span> <span class="o">==</span> <span class="s1">&#39;rf_amplitude&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;bsb vs rf amplitude&#39;</span>


<span class="k">class</span> <span class="nc">BkgdScanModel</span><span class="p">(</span><span class="n">TimeModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Heating Rate BSB Data Model &quot;&quot;&quot;</span>

    <span class="c1"># datasets</span>
    <span class="n">namespace</span> <span class="o">=</span> <span class="s1">&#39;heating_rate.bkgd&#39;</span>  <span class="c1">#: Dataset namespace</span>
    <span class="n">persist</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">broadcast</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">mirror</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># stats</span>
    <span class="n">enable_histograms</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># fits</span>

    <span class="n">fit_function</span> <span class="o">=</span> <span class="n">fit_functions</span><span class="o">.</span><span class="n">Line</span>
    <span class="n">main_fit</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">simulation_args</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;slope&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;y_intercept&#39;</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">}</span>

    <span class="c1"># plots</span>
    <span class="n">x_units</span> <span class="o">=</span> <span class="s1">&#39;us&#39;</span>
    <span class="n">x_scale</span> <span class="o">=</span> <span class="mi">1</span><span class="o">*</span><span class="n">us</span>
    <span class="n">plot_title</span> <span class="o">=</span> <span class="s1">&#39;bkgd&#39;</span>


<span class="k">class</span> <span class="nc">NbarScanModel</span><span class="p">(</span><span class="n">TimeModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Heating Rate Temp Model&quot;&quot;&quot;</span>

    <span class="c1"># datasets</span>
    <span class="n">namespace</span> <span class="o">=</span> <span class="s1">&#39;heating_rate.nbar.%type&#39;</span>  <span class="c1">#: Dataset namespace</span>
    <span class="n">mirror</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">persist</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">broadcast</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">to_scan</span> <span class="o">=</span> <span class="s1">&#39;wait_time&#39;</span>

    <span class="c1"># stats</span>
    <span class="n">enable_histograms</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># fits</span>
    <span class="n">fit_function</span> <span class="o">=</span> <span class="n">fit_functions</span><span class="o">.</span><span class="n">Line</span>
    <span class="n">fit_use_yerr</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">main_fit</span> <span class="o">=</span> <span class="s1">&#39;heating_rate&#39;</span>
    <span class="n">fit_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;slope&#39;</span><span class="p">:</span> <span class="s1">&#39;heating_rate&#39;</span>
    <span class="p">}</span>

    <span class="c1"># plots</span>
    <span class="n">y_label</span> <span class="o">=</span> <span class="s1">&#39;n bar&#39;</span>
    <span class="n">scan</span> <span class="o">=</span> <span class="s1">&#39;wait_time&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x_label</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_scan</span> <span class="o">==</span> <span class="s1">&#39;wait_time&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;wait time&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_scan</span> <span class="o">==</span> <span class="s1">&#39;rf_amplitude&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;rf amplitude&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_scan</span> <span class="o">==</span> <span class="s1">&#39;frequency&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;rf frequency&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x_units</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_scan</span> <span class="o">==</span> <span class="s1">&#39;wait_time&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;us&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_scan</span> <span class="o">==</span> <span class="s1">&#39;rf_amplitude&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_scan</span> <span class="o">==</span> <span class="s1">&#39;frequency&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;MHz&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_scan</span> <span class="o">==</span> <span class="s1">&#39;wait_time&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">us</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_scan</span> <span class="o">==</span> <span class="s1">&#39;rf_amplitude&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_scan</span> <span class="o">==</span> <span class="s1">&#39;frequency&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">MHz</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">plot_title</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_scan</span> <span class="o">==</span> <span class="s1">&#39;wait_time&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;nbar vs wait time&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_scan</span> <span class="o">==</span> <span class="s1">&#39;rf_amplitude&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;nbar vs rf amplitude&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_scan</span> <span class="o">==</span> <span class="s1">&#39;frequency&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;nbar vs rf frequency&#39;</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rsb_model</span><span class="p">,</span> <span class="n">bsb_model</span><span class="p">,</span> <span class="n">bkgd_model</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rsb_model</span> <span class="o">=</span> <span class="n">rsb_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bsb_model</span> <span class="o">=</span> <span class="n">bsb_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bkgd_model</span> <span class="o">=</span> <span class="n">bkgd_model</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load previously collected data into local storage within each model&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">load_datasets</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bsb_model</span><span class="o">.</span><span class="n">load_datasets</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rsb_model</span><span class="o">.</span><span class="n">load_datasets</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bkgd_model</span><span class="o">.</span><span class="n">load_datasets</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_point</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate nbar and the error in nbar at the given scan point index &#39;i&#39;&quot;&quot;&quot;</span>
        <span class="n">bsb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bsb_model</span><span class="o">.</span><span class="n">stat_model</span><span class="o">.</span><span class="n">means</span><span class="p">[</span><span class="n">i_point</span><span class="p">]</span>
        <span class="n">bsb_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bsb_model</span><span class="o">.</span><span class="n">stat_model</span><span class="o">.</span><span class="n">errors</span><span class="p">[</span><span class="n">i_point</span><span class="p">]</span>
        <span class="n">rsb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rsb_model</span><span class="o">.</span><span class="n">stat_model</span><span class="o">.</span><span class="n">means</span><span class="p">[</span><span class="n">i_point</span><span class="p">]</span>
        <span class="n">rsb_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rsb_model</span><span class="o">.</span><span class="n">stat_model</span><span class="o">.</span><span class="n">errors</span><span class="p">[</span><span class="n">i_point</span><span class="p">]</span>
        <span class="n">avgBkgd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bkgd_model</span><span class="o">.</span><span class="n">stat_model</span><span class="o">.</span><span class="n">means</span><span class="p">)</span>

        <span class="c1"># old calculation</span>
        <span class="c1">#ratio = (rsb - avgBkgd) / (bsb - avgBkgd)</span>
        <span class="c1">#nbar = ratio / (1 - ratio)</span>

        <span class="c1"># new calculation (uses an inverted ratio)</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">bsb</span> <span class="o">-</span> <span class="n">avgBkgd</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">rsb</span> <span class="o">-</span> <span class="n">avgBkgd</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">isnan</span><span class="p">(</span><span class="n">ratio</span><span class="p">):</span>
            <span class="n">nbar</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nbar</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">error</span> <span class="o">=</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">/</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">rsb_error</span> <span class="o">/</span> <span class="n">rsb</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">bsb_error</span> <span class="o">/</span> <span class="n">bsb</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">.5</span>
        <span class="k">return</span> <span class="n">nbar</span><span class="p">,</span> <span class="n">error</span>
</pre></div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="multiple_measurements.html" class="btn btn-neutral float-left" title="Performing multiple measurements" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="warmup_points.html" class="btn btn-neutral float-right" title="Running warmup points" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>